---
/**
 * TelegramFeed Component - Full view with all rich features
 * Shows: threads, replies, albums, polls, reactions, forwards, etc.
 */

import { t } from "../i18n";
import type { Locale } from "../i18n";

interface Props {
    lang: Locale;
    limit?: number;
}

const { lang, limit = 10 } = Astro.props;

const workerUrl =
    import.meta.env.PUBLIC_TELEGRAM_WORKER_URL ||
    "https://telegram-feed.mahhdy.workers.dev";
const channelUsername = import.meta.env.PUBLIC_TELEGRAM_CHANNEL || "@mahhdy57";
---

<div
    class="telegram-feed"
    data-worker-url={workerUrl}
    data-limit={limit}
    data-lang={lang}
    dir={lang === "fa" ? "rtl" : "ltr"}
>
    <div class="feed-header flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-3">
            <svg
                class="w-7 h-7 text-[#0088cc]"
                fill="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"
                ></path>
            </svg>
            {t("telegram.latest_posts", lang)}
        </h2>
    </div>

    <!-- Loading State -->
    <div class="feed-loading">
        <div class="flex items-center justify-center py-12">
            <svg
                class="animate-spin h-8 w-8 text-primary dark:text-primary-light"
                fill="none"
                viewBox="0 0 24 24"
            >
                <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"></circle>
                <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
            </svg>
            <p class="mr-3 text-text-muted dark:text-text-dark-muted">
                {t("telegram.loading", lang)}
            </p>
        </div>
    </div>

    <!-- Error State -->
    <div class="feed-error hidden">
        <div class="flex items-center justify-center py-12">
            <svg
                class="h-8 w-8 text-red-500 ml-3"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path>
            </svg>
            <p class="text-red-500">{t("telegram.error", lang)}</p>
        </div>
    </div>

    <!-- Posts Container -->
    <div class="feed-posts space-y-6">
        <!-- Posts will be injected here -->
    </div>

    <!-- View Channel Button -->
    {
        channelUsername && (
            <div class="text-center mt-8">
                <a
                    href={`https://t.me/${channelUsername.replace("@", "")}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 px-6 py-3 rounded-lg bg-[#0088cc] text-white hover:bg-[#0077b3] transition-colors font-medium"
                >
                    <svg
                        class="w-5 h-5"
                        fill="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z" />
                    </svg>
                    {t("telegram.view_channel", lang)}
                    <svg
                        class="w-4 h-4"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                        />
                    </svg>
                </a>
            </div>
        )
    }
</div>

<script>
    // ============================================================
    // TYPES
    // ============================================================

    interface MediaItem {
        type: string;
        url?: string;
        thumbnail?: string;
        title?: string;
        description?: string;
        duration?: string;
        durationSeconds?: number;
        fileName?: string;
        fileSize?: string;
        fileSizeBytes?: number;
        width?: number;
        height?: number;
        performer?: string;
        mimeType?: string;
        emoji?: string;
        setName?: string;
        isAnimated?: boolean;
        isVideo?: boolean;
    }

    interface ReplyToPost {
        id: string;
        text: string;
        textHtml?: string;
        date?: number;
        hasMedia?: boolean;
        mediaType?: string;
        mediaThumbnail?: string;
        link: string;
    }

    interface ThreadPart {
        current: number;
        total: number | null;
    }

    interface PollOption {
        text: string;
        voterCount: number;
    }

    interface Poll {
        id?: string;
        question: string;
        options: PollOption[];
        totalVoters: number;
        isAnonymous?: boolean;
        type?: string;
        allowsMultiple?: boolean;
        isClosed?: boolean;
        explanation?: string;
    }

    interface ForwardedFrom {
        type: string;
        id?: number;
        name: string;
        username?: string;
        url?: string;
    }

    interface Reaction {
        emoji: string;
        count: number;
    }

    interface TelegramPost {
        id: string;
        text: string;
        textHtml?: string;
        date: number;
        views: number;
        link: string;
        media?: MediaItem[];
        hasMedia?: boolean;
        isAlbum?: boolean;
        albumCount?: number;
        forwardedFrom?: ForwardedFrom;
        replyTo?: { id: string; url: string; author?: string; text?: string };
        replyToPost?: ReplyToPost;
        poll?: Poll;
        threadPart?: ThreadPart;
        isContinuation?: boolean;
        reactions?: Reaction[];
        edited?: boolean;
        editDate?: number;
        source?: string;
    }

    // ============================================================
    // HELPERS
    // ============================================================

    function escapeHtml(str: string): string {
        return (str || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    }

    function formatDate(timestamp: number, lang: "fa" | "en"): string {
        const date = new Date(timestamp * 1000);
        return new Intl.DateTimeFormat(lang === "fa" ? "fa-IR" : "en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
        }).format(date);
    }

    function formatViews(views: number, lang: "fa" | "en"): string {
        return views.toLocaleString(lang === "fa" ? "fa-IR" : "en-US");
    }

    function formatFileSize(bytes: number): string {
        if (!bytes) return "";
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    }

    // ============================================================
    // MAIN CARD BUILDER
    // ============================================================

    function createPostCard(
        post: TelegramPost,
        lang: "fa" | "en",
    ): HTMLElement {
        const card = document.createElement("article");
        card.className = "post-card";
        card.setAttribute("dir", lang === "fa" ? "rtl" : "ltr");
        card.id = `post-${post.id}`;

        let html = "";

        // === Top badges ===
        html += buildTopBadges(post, lang);

        // === Forwarded from ===
        if (post.forwardedFrom) {
            html += buildForwardedFrom(post.forwardedFrom, lang);
        }

        // === Reply to (with full content if available) ===
        if (post.replyTo || post.replyToPost) {
            html += buildReplyTo(post, lang);
        }

        // === Meta info ===
        html += buildMeta(post, lang);

        // === Media (albums, photos, videos, etc.) ===
        if (post.media && post.media.length > 0) {
            html += buildMedia(post, lang);
        }

        // === Poll ===
        if (post.poll) {
            html += buildPoll(post.poll, lang);
        }

        // === Text content ===
        if (post.textHtml || post.text) {
            html += buildTextContent(post);
        }

        // === Reactions ===
        if (post.reactions && post.reactions.length > 0) {
            html += buildReactions(post.reactions, lang);
        }

        // === Footer (View on Telegram) ===
        html += buildFooter(post, lang);

        card.innerHTML = html;
        return card;
    }

    // ============================================================
    // COMPONENT BUILDERS
    // ============================================================

    function buildTopBadges(post: TelegramPost, lang: "fa" | "en"): string {
        const badges: string[] = [];

        // Thread part
        if (post.threadPart) {
            const partText = post.threadPart.total
                ? `${post.threadPart.current}/${post.threadPart.total}`
                : `${lang === "fa" ? "ÿ®ÿÆÿ¥" : "Part"} ${post.threadPart.current}`;
            badges.push(`
        <span class="post-badge badge-thread">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          ${partText}
        </span>
      `);
        }

        // Continuation
        if (post.isContinuation && !post.threadPart) {
            badges.push(`
        <span class="post-badge badge-continuation">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
          </svg>
          ${lang === "fa" ? "ÿßÿØÿßŸÖŸá ŸÖÿ∑ŸÑÿ® ŸÇÿ®ŸÑ" : "Continuation"}
        </span>
      `);
        }

        // Album
        if (post.isAlbum && post.albumCount) {
            badges.push(`
        <span class="post-badge badge-album">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          ${post.albumCount} ${lang === "fa" ? "ÿ™ÿµŸà€åÿ±" : "images"}
        </span>
      `);
        }

        // Edited
        if (post.edited) {
            const editText = post.editDate
                ? formatDate(post.editDate, lang)
                : lang === "fa"
                  ? "Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØŸá"
                  : "Edited";
            badges.push(`
        <span class="post-badge badge-edited" title="${editText}">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
          </svg>
          ${lang === "fa" ? "Ÿà€åÿ±ÿß€åÿ¥ ÿ¥ÿØŸá" : "Edited"}
        </span>
      `);
        }

        if (badges.length === 0) return "";

        return `<div class="post-badges">${badges.join("")}</div>`;
    }

    function buildForwardedFrom(fwd: ForwardedFrom, lang: "fa" | "en"): string {
        const icon =
            fwd.type === "channel"
                ? `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
        </svg>`
                : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>`;

        const link = fwd.url
            ? `<a href="${fwd.url}" target="_blank" rel="noopener" class="fwd-name">${escapeHtml(fwd.name)}</a>`
            : `<span class="fwd-name">${escapeHtml(fwd.name)}</span>`;

        return `
      <div class="forwarded-from">
        ${icon}
        <span class="fwd-label">${lang === "fa" ? "ŸÅŸàÿ±Ÿàÿßÿ±ÿØ ÿ¥ÿØŸá ÿßÿ≤" : "Forwarded from"}</span>
        ${link}
      </div>
    `;
    }

    function buildReplyTo(post: TelegramPost, lang: "fa" | "en"): string {
        const reply = post.replyToPost || post.replyTo;
        if (!reply) return "";

        const hasFullContent = post.replyToPost && post.replyToPost.text;
        const replyText = hasFullContent
            ? post.replyToPost!.text
            : post.replyTo?.text || "";
        const replyLink = post.replyToPost?.link || post.replyTo?.url || "";
        const replyId = post.replyToPost?.id || post.replyTo?.id || "";

        let mediaIndicator = "";
        if (post.replyToPost?.hasMedia) {
            const mediaType = post.replyToPost.mediaType;
            const icons: Record<string, string> = {
                photo: "üñºÔ∏è",
                video: "üé¨",
                audio: "üéµ",
                voice: "üé§",
                document: "üìé",
                sticker: "üé®",
            };
            mediaIndicator = `<span class="reply-media-indicator">${icons[mediaType || "photo"] || "üìé"}</span>`;
        }

        return `
      <div class="reply-to-container">
        <div class="reply-to-header">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
          </svg>
          <span>${lang === "fa" ? "ÿØÿ± Ÿæÿßÿ≥ÿÆ ÿ®Ÿá Ÿæÿ≥ÿ™" : "In reply to post"} #${replyId}</span>
          ${mediaIndicator}
          <a href="${replyLink}" target="_blank" rel="noopener" class="reply-link">
            ${lang === "fa" ? "ŸÖÿ¥ÿßŸáÿØŸá ‚Üó" : "View ‚Üó"}
          </a>
        </div>
        ${
            replyText
                ? `<div class="reply-to-content">${escapeHtml(replyText.slice(0, 200))}${replyText.length > 200 ? "‚Ä¶" : ""}</div>`
                : `<div class="reply-to-content reply-no-text">${lang === "fa" ? "(ŸÖÿ≠ÿ™Ÿàÿß€å ŸÖÿ™ŸÜ€å ŸÜÿØÿßÿ±ÿØ)" : "(No text content)"}</div>`
        }
      </div>
    `;
    }

    function buildMeta(post: TelegramPost, lang: "fa" | "en"): string {
        const date = formatDate(post.date, lang);
        const views = formatViews(post.views, lang);

        return `
      <div class="post-meta">
        <span class="meta-item">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          ${date}
        </span>
        <span class="meta-item">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
          </svg>
          ${views} ${lang === "fa" ? "ÿ®ÿßÿ≤ÿØ€åÿØ" : "views"}
        </span>
        <span class="meta-item meta-id">
          #${post.id}
        </span>
      </div>
    `;
    }

    function buildMedia(post: TelegramPost, lang: "fa" | "en"): string {
        const media = post.media || [];
        if (media.length === 0) return "";

        // Separate by type
        const photos = media.filter((m) => m.type === "photo");
        const videos = media.filter((m) => m.type === "video");
        const audios = media.filter((m) => m.type === "audio");
        const voices = media.filter((m) => m.type === "voice");
        const documents = media.filter((m) => m.type === "document");
        const stickers = media.filter((m) => m.type === "sticker");
        const linkPreviews = media.filter((m) => m.type === "linkPreview");
        const roundVideos = media.filter((m) => m.type === "roundvideo");
        const animations = media.filter((m) => m.type === "animation");

        let html = '<div class="post-media">';

        // Album / Photo grid
        if (photos.length > 0) {
            html += buildPhotoGrid(photos, post.link);
        }

        // Videos
        for (const video of videos) {
            html += buildVideo(video, post.link, lang);
        }

        // Round videos
        for (const rv of roundVideos) {
            html += buildRoundVideo(rv, post.link);
        }

        // Animations (GIFs)
        for (const anim of animations) {
            html += buildAnimation(anim, post.link);
        }

        // Audio files
        for (const audio of audios) {
            html += buildAudio(audio, post.link, lang);
        }

        // Voice messages
        for (const voice of voices) {
            html += buildVoice(voice, post.link, lang);
        }

        // Documents
        for (const doc of documents) {
            html += buildDocument(doc, post.link, lang);
        }

        // Stickers
        for (const sticker of stickers) {
            html += buildSticker(sticker);
        }

        // Link previews
        for (const lp of linkPreviews) {
            html += buildLinkPreview(lp);
        }

        html += "</div>";
        return html;
    }

    function buildPhotoGrid(photos: MediaItem[], postLink: string): string {
        if (photos.length === 1) {
            return `
        <a href="${postLink}" target="_blank" class="media-photo single">
          <img src="${photos[0].url || photos[0].thumbnail}" alt="" loading="lazy" />
        </a>
      `;
        }

        // Multiple photos - grid layout
        const gridClass =
            photos.length === 2
                ? "grid-2"
                : photos.length === 3
                  ? "grid-3"
                  : photos.length === 4
                    ? "grid-4"
                    : "grid-many";

        let html = `<div class="media-photo-grid ${gridClass}">`;
        for (let i = 0; i < Math.min(photos.length, 6); i++) {
            const isLast = i === 5 && photos.length > 6;
            html += `
        <a href="${postLink}" target="_blank" class="media-photo ${isLast ? "has-more" : ""}">
          <img src="${photos[i].url || photos[i].thumbnail}" alt="" loading="lazy" />
          ${isLast ? `<span class="more-count">+${photos.length - 6}</span>` : ""}
        </a>
      `;
        }
        html += "</div>";
        return html;
    }

    function buildVideo(
        video: MediaItem,
        postLink: string,
        lang: "fa" | "en",
    ): string {
        if (video.url) {
            return `
        <div class="media-video">
          <video controls poster="${video.thumbnail || ""}">
            <source src="${video.url}" type="${video.mimeType || "video/mp4"}" />
          </video>
          ${video.duration ? `<span class="video-duration">${video.duration}</span>` : ""}
        </div>
      `;
        }

        // No direct URL - show thumbnail with play button
        return `
      <a href="${postLink}" target="_blank" class="media-video-preview">
        <img src="${video.thumbnail}" alt="" loading="lazy" />
        <div class="play-overlay">
          <div class="play-button">
            <svg class="w-12 h-12" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </div>
        </div>
        ${video.duration ? `<span class="video-duration">${video.duration}</span>` : ""}
        <span class="video-label">${lang === "fa" ? "Ÿà€åÿØ€åŸà" : "Video"}</span>
      </a>
    `;
    }

    function buildRoundVideo(rv: MediaItem, postLink: string): string {
        if (rv.url) {
            return `
        <div class="media-round-video">
          <video controls class="round-video" poster="${rv.thumbnail || ""}">
            <source src="${rv.url}" type="video/mp4" />
          </video>
          ${rv.duration ? `<span class="video-duration">${rv.duration}</span>` : ""}
        </div>
      `;
        }

        return `
      <a href="${postLink}" target="_blank" class="media-round-video-preview">
        <img src="${rv.thumbnail}" alt="" loading="lazy" />
        <div class="play-overlay round">
          <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
        ${rv.duration ? `<span class="video-duration">${rv.duration}</span>` : ""}
      </a>
    `;
    }

    function buildAnimation(anim: MediaItem, postLink: string): string {
        if (anim.url) {
            return `
        <div class="media-animation">
          <video autoplay loop muted playsinline poster="${anim.thumbnail || ""}">
            <source src="${anim.url}" type="video/mp4" />
          </video>
          <span class="gif-label">GIF</span>
        </div>
      `;
        }

        return `
      <a href="${postLink}" target="_blank" class="media-animation-preview">
        <img src="${anim.thumbnail}" alt="" loading="lazy" />
        <span class="gif-label">GIF</span>
      </a>
    `;
    }

    function buildAudio(
        audio: MediaItem,
        postLink: string,
        lang: "fa" | "en",
    ): string {
        const title =
            audio.title || (lang === "fa" ? "ŸÅÿß€åŸÑ ÿµŸàÿ™€å" : "Audio file");
        const performer = audio.performer || "";

        if (audio.url) {
            return `
        <div class="media-audio">
          <div class="audio-icon">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
            </svg>
          </div>
          <div class="audio-info">
            <span class="audio-title">${escapeHtml(title)}</span>
            ${performer ? `<span class="audio-performer">${escapeHtml(performer)}</span>` : ""}
            ${audio.duration ? `<span class="audio-duration">${audio.duration}</span>` : ""}
          </div>
          <audio controls src="${audio.url}"></audio>
        </div>
      `;
        }

        return `
      <a href="${postLink}" target="_blank" class="media-audio no-playback">
        <div class="audio-icon">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
          </svg>
        </div>
        <div class="audio-info">
          <span class="audio-title">${escapeHtml(title)}</span>
          ${performer ? `<span class="audio-performer">${escapeHtml(performer)}</span>` : ""}
          ${audio.duration ? `<span class="audio-duration">${audio.duration}</span>` : ""}
        </div>
        <span class="download-label">${lang === "fa" ? "ÿØÿßŸÜŸÑŸàÿØ" : "Download"} ‚Üó</span>
      </a>
    `;
    }

    function buildVoice(
        voice: MediaItem,
        postLink: string,
        lang: "fa" | "en",
    ): string {
        if (voice.url) {
            return `
        <div class="media-voice">
          <div class="voice-icon">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
            </svg>
          </div>
          <audio controls src="${voice.url}" class="voice-player"></audio>
          ${voice.duration ? `<span class="voice-duration">${voice.duration}</span>` : ""}
        </div>
      `;
        }

        return `
      <a href="${postLink}" target="_blank" class="media-voice no-playback">
        <div class="voice-icon">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
          </svg>
        </div>
        <div class="voice-waveform">
          <div class="waveform-bar"></div>
        </div>
        ${voice.duration ? `<span class="voice-duration">${voice.duration}</span>` : ""}
      </a>
    `;
    }

    function buildDocument(
        doc: MediaItem,
        postLink: string,
        lang: "fa" | "en",
    ): string {
        const fileName = doc.fileName || (lang === "fa" ? "ŸÅÿß€åŸÑ" : "File");
        const fileSize =
            doc.fileSize ||
            (doc.fileSizeBytes ? formatFileSize(doc.fileSizeBytes) : "");

        return `
      <a href="${postLink}" target="_blank" class="media-document">
        <div class="doc-icon">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="doc-info">
          <span class="doc-name">${escapeHtml(fileName)}</span>
          ${fileSize ? `<span class="doc-size">${fileSize}</span>` : ""}
        </div>
        <div class="doc-download">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
          </svg>
        </div>
      </a>
    `;
    }

    function buildSticker(sticker: MediaItem): string {
        return `
      <div class="media-sticker">
        <img src="${sticker.url}" alt="${sticker.emoji || "Sticker"}" loading="lazy" />
        ${sticker.emoji ? `<span class="sticker-emoji">${sticker.emoji}</span>` : ""}
      </div>
    `;
    }

    function buildLinkPreview(lp: MediaItem): string {
        return `
      <a href="${lp.url}" target="_blank" rel="noopener noreferrer" class="media-link-preview">
        ${
            lp.thumbnail
                ? `<div class="lp-thumb"><img src="${lp.thumbnail}" alt="" loading="lazy" /></div>`
                : ""
        }
        <div class="lp-content">
          ${lp.title ? `<span class="lp-title">${escapeHtml(lp.title)}</span>` : ""}
          ${lp.description ? `<span class="lp-desc">${escapeHtml(lp.description)}</span>` : ""}
          <span class="lp-url">${new URL(lp.url || "").hostname}</span>
        </div>
      </a>
    `;
    }

    function buildPoll(poll: Poll, lang: "fa" | "en"): string {
        const maxVotes = Math.max(...poll.options.map((o) => o.voterCount), 1);

        let optionsHtml = "";
        for (const option of poll.options) {
            const percentage =
                poll.totalVoters > 0
                    ? Math.round((option.voterCount / poll.totalVoters) * 100)
                    : 0;
            const barWidth = Math.round((option.voterCount / maxVotes) * 100);

            optionsHtml += `
        <div class="poll-option">
          <div class="poll-option-bar" style="width: ${barWidth}%"></div>
          <span class="poll-option-text">${escapeHtml(option.text)}</span>
          <span class="poll-option-percent">${percentage}%</span>
          <span class="poll-option-votes">${option.voterCount.toLocaleString(lang === "fa" ? "fa-IR" : "en-US")}</span>
        </div>
      `;
        }

        const statusBadges = [];
        if (poll.isClosed) {
            statusBadges.push(
                `<span class="poll-status closed">${lang === "fa" ? "ÿ®ÿ≥ÿ™Ÿá ÿ¥ÿØŸá" : "Closed"}</span>`,
            );
        }
        if (poll.isAnonymous) {
            statusBadges.push(
                `<span class="poll-status anon">${lang === "fa" ? "ŸÜÿßÿ¥ŸÜÿßÿ≥" : "Anonymous"}</span>`,
            );
        }
        if (poll.allowsMultiple) {
            statusBadges.push(
                `<span class="poll-status multi">${lang === "fa" ? "⁄ÜŸÜÿØ ÿßŸÜÿ™ÿÆÿßÿ®€å" : "Multiple choice"}</span>`,
            );
        }

        return `
      <div class="post-poll">
        <div class="poll-header">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <span class="poll-question">${escapeHtml(poll.question)}</span>
        </div>
        ${statusBadges.length > 0 ? `<div class="poll-statuses">${statusBadges.join("")}</div>` : ""}
        <div class="poll-options">
          ${optionsHtml}
        </div>
        <div class="poll-footer">
          ${poll.totalVoters.toLocaleString(lang === "fa" ? "fa-IR" : "en-US")} ${lang === "fa" ? "ÿ±ÿß€å" : "votes"}
        </div>
        ${poll.explanation ? `<div class="poll-explanation">${escapeHtml(poll.explanation)}</div>` : ""}
      </div>
    `;
    }

    function buildTextContent(post: TelegramPost): string {
        let content = post.textHtml || escapeHtml(post.text || "");
        content = content.replace(/\n/g, "<br />");

        return `<div class="post-text">${content}</div>`;
    }

    function buildReactions(reactions: Reaction[], lang: "fa" | "en"): string {
        let html = '<div class="post-reactions">';

        for (const reaction of reactions) {
            html += `
        <span class="reaction">
          <span class="reaction-emoji">${reaction.emoji}</span>
          <span class="reaction-count">${reaction.count.toLocaleString(lang === "fa" ? "fa-IR" : "en-US")}</span>
        </span>
      `;
        }

        html += "</div>";
        return html;
    }

    function buildFooter(post: TelegramPost, lang: "fa" | "en"): string {
        return `
      <div class="post-footer">
        <a href="${post.link}" target="_blank" rel="noopener noreferrer" class="view-telegram">
          ${lang === "fa" ? "ŸÖÿ¥ÿßŸáÿØŸá ÿØÿ± ÿ™ŸÑ⁄Øÿ±ÿßŸÖ" : "View on Telegram"}
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${lang === "fa" ? "M15 19l-7-7 7-7" : "M9 5l7 7-7 7"}" />
          </svg>
        </a>
      </div>
    `;
    }

    // ============================================================
    // INITIALIZATION
    // ============================================================

    document.querySelectorAll(".telegram-feed").forEach(async (container) => {
        const workerUrl = container.getAttribute("data-worker-url");
        const limit = parseInt(container.getAttribute("data-limit") || "10");
        const lang = container.getAttribute("data-lang") as "fa" | "en";

        const loadingEl = container.querySelector(
            ".feed-loading",
        ) as HTMLElement;
        const errorEl = container.querySelector(".feed-error") as HTMLElement;
        const postsEl = container.querySelector(".feed-posts") as HTMLElement;

        if (!workerUrl) {
            loadingEl.classList.add("hidden");
            errorEl.classList.remove("hidden");
            return;
        }

        try {
            const response = await fetch(workerUrl);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const posts: TelegramPost[] = await response.json();

            loadingEl.classList.add("hidden");

            if (!Array.isArray(posts) || posts.length === 0) {
                errorEl.classList.remove("hidden");
                errorEl.querySelector("p")!.textContent =
                    lang === "fa" ? "Ÿæÿ≥ÿ™€å €åÿßŸÅÿ™ ŸÜÿ¥ÿØ" : "No posts found";
                return;
            }

            posts.slice(0, limit).forEach((post) => {
                const postCard = createPostCard(post, lang);
                postsEl.appendChild(postCard);
            });
        } catch (error) {
            console.error("Telegram feed error:", error);
            loadingEl.classList.add("hidden");
            errorEl.classList.remove("hidden");
        }
    });
</script>

<style>
    /* ============================================================
     CONTAINER
     ============================================================ */
    .telegram-feed {
        background-color: var(--color-surface-dim);
        border-radius: 0.75rem;
        padding: 2rem;
        border: 1px solid var(--color-border);
    }

    html.dark .telegram-feed {
        background-color: var(--color-surface-dark-dim);
        border-color: var(--color-border-dark);
    }

    /* ============================================================
     POST CARD
     ============================================================ */
    .post-card {
        padding: 1.5rem;
        border-radius: 0.75rem;
        background-color: var(--color-surface);
        border: 1px solid var(--color-border);
        transition: all 0.2s ease;
    }

    html.dark .post-card {
        background-color: var(--color-surface-dark);
        border-color: var(--color-border-dark);
    }

    .post-card:hover {
        border-color: #0088cc;
        box-shadow: 0 4px 16px rgba(0, 136, 204, 0.1);
    }

    /* ============================================================
     BADGES
     ============================================================ */
    .post-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .post-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.3rem 0.6rem;
        border-radius: 0.375rem;
    }

    .badge-thread {
        background-color: #0088cc20;
        color: #0088cc;
    }

    .badge-continuation {
        background-color: #10b98120;
        color: #10b981;
    }

    .badge-album {
        background-color: #8b5cf620;
        color: #8b5cf6;
    }

    .badge-edited {
        background-color: #f5920020;
        color: #f59200;
    }

    /* ============================================================
     FORWARDED FROM
     ============================================================ */
    .forwarded-from {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        margin-bottom: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: var(--color-surface-dim);
        border-radius: 0.5rem;
    }

    html.dark .forwarded-from {
        background-color: var(--color-surface-dark-dim);
        color: var(--color-text-dark-muted);
    }

    .fwd-label {
        opacity: 0.8;
    }

    .fwd-name {
        font-weight: 600;
        color: #0088cc;
        text-decoration: none;
    }

    .fwd-name:hover {
        text-decoration: underline;
    }

    /* ============================================================
     REPLY TO
     ============================================================ */
    .reply-to-container {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background-color: var(--color-surface-dim);
        border-radius: 0.5rem;
        border-inline-start: 3px solid #0088cc;
    }

    html.dark .reply-to-container {
        background-color: var(--color-surface-dark-dim);
    }

    .reply-to-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        color: #0088cc;
        margin-bottom: 0.5rem;
    }

    .reply-media-indicator {
        font-size: 0.875rem;
    }

    .reply-link {
        margin-inline-start: auto;
        font-size: 0.75rem;
        color: #0088cc;
        text-decoration: none;
    }

    .reply-link:hover {
        text-decoration: underline;
    }

    .reply-to-content {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        line-height: 1.5;
    }

    html.dark .reply-to-content {
        color: var(--color-text-dark-muted);
    }

    .reply-no-text {
        font-style: italic;
        opacity: 0.7;
    }

    /* ============================================================
     META
     ============================================================ */
    .post-meta {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 1rem;
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        margin-bottom: 1rem;
    }

    html.dark .post-meta {
        color: var(--color-text-dark-muted);
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .meta-id {
        opacity: 0.6;
        font-family: ui-monospace, monospace;
        font-size: 0.75rem;
    }

    /* ============================================================
     MEDIA - PHOTOS
     ============================================================ */
    .post-media {
        margin-bottom: 1rem;
    }

    .media-photo.single img {
        max-height: 500px;
        width: auto;
        max-width: 100%;
        border-radius: 0.75rem;
        object-fit: contain;
    }

    .media-photo-grid {
        display: grid;
        gap: 0.25rem;
        border-radius: 0.75rem;
        overflow: hidden;
    }

    .media-photo-grid.grid-2 {
        grid-template-columns: 1fr 1fr;
    }

    .media-photo-grid.grid-3 {
        grid-template-columns: 2fr 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .media-photo-grid.grid-3 .media-photo:first-child {
        grid-row: span 2;
    }

    .media-photo-grid.grid-4 {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }

    .media-photo-grid.grid-many {
        grid-template-columns: repeat(3, 1fr);
    }

    .media-photo-grid .media-photo {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
    }

    .media-photo-grid .media-photo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s ease;
    }

    .media-photo-grid .media-photo:hover img {
        transform: scale(1.05);
    }

    .media-photo.has-more::after {
        content: "";
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .more-count {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        z-index: 1;
    }

    /* ============================================================
     MEDIA - VIDEO
     ============================================================ */
    .media-video {
        position: relative;
        border-radius: 0.75rem;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .media-video video {
        width: 100%;
        max-height: 500px;
        background-color: black;
    }

    .media-video-preview {
        position: relative;
        display: block;
        border-radius: 0.75rem;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .media-video-preview img {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
    }

    .play-overlay {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(0, 0, 0, 0.3);
        transition: background-color 0.2s ease;
    }

    .media-video-preview:hover .play-overlay {
        background-color: rgba(0, 0, 0, 0.5);
    }

    .play-button {
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: transform 0.2s ease;
    }

    .media-video-preview:hover .play-button {
        transform: scale(1.1);
    }

    .video-duration {
        position: absolute;
        bottom: 0.5rem;
        inset-inline-end: 0.5rem;
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-family: ui-monospace, monospace;
    }

    .video-label {
        position: absolute;
        top: 0.5rem;
        inset-inline-start: 0.5rem;
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        font-size: 0.625rem;
        font-weight: 600;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        text-transform: uppercase;
    }

    /* ============================================================
     MEDIA - ROUND VIDEO
     ============================================================ */
    .media-round-video,
    .media-round-video-preview {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        overflow: hidden;
        position: relative;
        margin-bottom: 0.5rem;
    }

    .media-round-video video,
    .media-round-video-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .play-overlay.round {
        border-radius: 50%;
    }

    /* ============================================================
     MEDIA - ANIMATION (GIF)
     ============================================================ */
    .media-animation,
    .media-animation-preview {
        position: relative;
        border-radius: 0.75rem;
        overflow: hidden;
        margin-bottom: 0.5rem;
        display: block;
    }

    .media-animation video,
    .media-animation-preview img {
        max-width: 100%;
        max-height: 400px;
    }

    .gif-label {
        position: absolute;
        bottom: 0.5rem;
        inset-inline-start: 0.5rem;
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        font-size: 0.625rem;
        font-weight: 700;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
    }

    /* ============================================================
     MEDIA - AUDIO
     ============================================================ */
    .media-audio {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background-color: var(--color-surface-dim);
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
        color: inherit;
        transition: background-color 0.2s ease;
    }

    html.dark .media-audio {
        background-color: var(--color-surface-dark-dim);
    }

    .media-audio:hover {
        background-color: var(--color-surface);
    }

    html.dark .media-audio:hover {
        background-color: var(--color-surface-dark);
    }

    .audio-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        background-color: #0088cc20;
        color: #0088cc;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .audio-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .audio-title {
        font-weight: 600;
        color: var(--color-text-base);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    html.dark .audio-title {
        color: var(--color-text-dark);
    }

    .audio-performer {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
    }

    html.dark .audio-performer {
        color: var(--color-text-dark-muted);
    }

    .audio-duration {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        font-family: ui-monospace, monospace;
    }

    .media-audio audio {
        flex-shrink: 0;
        height: 2rem;
        max-width: 200px;
    }

    .download-label {
        font-size: 0.8125rem;
        color: #0088cc;
        flex-shrink: 0;
    }

    /* ============================================================
     MEDIA - VOICE
     ============================================================ */
    .media-voice {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background-color: var(--color-surface-dim);
        border-radius: 2rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
        color: inherit;
    }

    html.dark .media-voice {
        background-color: var(--color-surface-dark-dim);
    }

    .voice-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 50%;
        background-color: #0088cc;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .voice-player {
        flex: 1;
        height: 2rem;
    }

    .voice-waveform {
        flex: 1;
        height: 1.5rem;
        display: flex;
        align-items: center;
    }

    .waveform-bar {
        width: 100%;
        height: 4px;
        background-color: var(--color-text-muted);
        opacity: 0.3;
        border-radius: 2px;
    }

    .voice-duration {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        font-family: ui-monospace, monospace;
        flex-shrink: 0;
    }

    /* ============================================================
     MEDIA - DOCUMENT (continued)
     ============================================================ */
    .media-document {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background-color: var(--color-surface-dim);
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
        color: inherit;
        border: 1px solid var(--color-border);
        transition: all 0.2s ease;
    }

    html.dark .media-document {
        background-color: var(--color-surface-dark-dim);
        border-color: var(--color-border-dark);
    }

    .media-document:hover {
        border-color: #0088cc;
        background-color: var(--color-surface);
    }

    html.dark .media-document:hover {
        background-color: var(--color-surface-dark);
    }

    .doc-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.5rem;
        background-color: #3b82f620;
        color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .doc-info {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .doc-name {
        font-weight: 600;
        color: var(--color-text-base);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    html.dark .doc-name {
        color: var(--color-text-dark);
    }

    .doc-size {
        font-size: 0.75rem;
        color: var(--color-text-muted);
    }

    html.dark .doc-size {
        color: var(--color-text-dark-muted);
    }

    .doc-download {
        color: var(--color-text-muted);
        flex-shrink: 0;
    }

    .media-document:hover .doc-download {
        color: #0088cc;
    }

    /* ============================================================
     MEDIA - STICKER
     ============================================================ */
    .media-sticker {
        display: inline-block;
        position: relative;
        margin-bottom: 0.5rem;
    }

    .media-sticker img {
        width: 150px;
        height: 150px;
        object-fit: contain;
    }

    .sticker-emoji {
        position: absolute;
        bottom: 0;
        inset-inline-end: 0;
        font-size: 1.25rem;
    }

    /* ============================================================
     MEDIA - LINK PREVIEW
     ============================================================ */
    .media-link-preview {
        display: flex;
        gap: 0.75rem;
        padding: 0.75rem;
        background-color: var(--color-surface-dim);
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        text-decoration: none;
        color: inherit;
        border: 1px solid var(--color-border);
        transition: all 0.2s ease;
    }

    html.dark .media-link-preview {
        background-color: var(--color-surface-dark-dim);
        border-color: var(--color-border-dark);
    }

    .media-link-preview:hover {
        border-color: #0088cc;
    }

    .lp-thumb {
        width: 80px;
        height: 80px;
        border-radius: 0.5rem;
        overflow: hidden;
        flex-shrink: 0;
    }

    .lp-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .lp-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .lp-title {
        font-weight: 600;
        color: #0088cc;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .lp-desc {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    html.dark .lp-desc {
        color: var(--color-text-dark-muted);
    }

    .lp-url {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        opacity: 0.7;
    }

    /* ============================================================
     POLL
     ============================================================ */
    .post-poll {
        background-color: var(--color-surface-dim);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid var(--color-border);
    }

    html.dark .post-poll {
        background-color: var(--color-surface-dark-dim);
        border-color: var(--color-border-dark);
    }

    .poll-header {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        color: #0088cc;
    }

    .poll-question {
        font-weight: 700;
        font-size: 1rem;
        color: var(--color-text-base);
        line-height: 1.4;
    }

    html.dark .poll-question {
        color: var(--color-text-dark);
    }

    .poll-statuses {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .poll-status {
        font-size: 0.6875rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
    }

    .poll-status.closed {
        background-color: #ef444420;
        color: #ef4444;
    }

    .poll-status.anon {
        background-color: #8b5cf620;
        color: #8b5cf6;
    }

    .poll-status.multi {
        background-color: #10b98120;
        color: #10b981;
    }

    .poll-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .poll-option {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.6rem 0.75rem;
        background-color: var(--color-surface);
        border-radius: 0.5rem;
        overflow: hidden;
    }

    html.dark .poll-option {
        background-color: var(--color-surface-dark);
    }

    .poll-option-bar {
        position: absolute;
        inset-inline-start: 0;
        top: 0;
        bottom: 0;
        background-color: #0088cc20;
        border-radius: 0.5rem;
        z-index: 0;
    }

    .poll-option-text {
        flex: 1;
        font-size: 0.875rem;
        color: var(--color-text-base);
        position: relative;
        z-index: 1;
    }

    html.dark .poll-option-text {
        color: var(--color-text-dark);
    }

    .poll-option-percent {
        font-size: 0.8125rem;
        font-weight: 600;
        color: #0088cc;
        position: relative;
        z-index: 1;
    }

    .poll-option-votes {
        font-size: 0.75rem;
        color: var(--color-text-muted);
        position: relative;
        z-index: 1;
    }

    html.dark .poll-option-votes {
        color: var(--color-text-dark-muted);
    }

    .poll-footer {
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        text-align: center;
    }

    html.dark .poll-footer {
        color: var(--color-text-dark-muted);
    }

    .poll-explanation {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid var(--color-border);
        font-size: 0.8125rem;
        color: var(--color-text-muted);
        font-style: italic;
    }

    html.dark .poll-explanation {
        border-color: var(--color-border-dark);
        color: var(--color-text-dark-muted);
    }

    /* ============================================================
     TEXT CONTENT
     ============================================================ */
    .post-text {
        font-size: 0.9375rem;
        line-height: 1.7;
        color: var(--color-text-base);
        margin-bottom: 1rem;
    }

    html.dark .post-text {
        color: var(--color-text-dark);
    }

    .post-text a {
        color: #0088cc;
        text-decoration: underline;
        text-underline-offset: 2px;
    }

    .post-text a:hover {
        color: #006699;
    }

    .post-text strong {
        font-weight: 700;
    }

    .post-text em {
        font-style: italic;
    }

    .post-text code {
        background-color: var(--color-surface-dim);
        padding: 0.15rem 0.4rem;
        border-radius: 0.25rem;
        font-family:
            ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.875em;
    }

    html.dark .post-text code {
        background-color: var(--color-surface-dark-dim);
    }

    .post-text pre {
        background-color: var(--color-surface-dim);
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        font-family:
            ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
        font-size: 0.875em;
        margin: 0.75rem 0;
    }

    html.dark .post-text pre {
        background-color: var(--color-surface-dark-dim);
    }

    .post-text blockquote {
        border-inline-start: 3px solid #0088cc;
        padding-inline-start: 1rem;
        margin: 0.75rem 0;
        color: var(--color-text-muted);
        font-style: italic;
    }

    html.dark .post-text blockquote {
        color: var(--color-text-dark-muted);
    }

    .post-text .hashtag {
        color: #0088cc;
        font-weight: 500;
        text-decoration: none;
    }

    .post-text .hashtag:hover {
        text-decoration: underline;
    }

    .post-text .mention {
        color: #0088cc;
        text-decoration: none;
    }

    .post-text .mention:hover {
        text-decoration: underline;
    }

    .post-text .spoiler {
        background-color: var(--color-text-base);
        color: transparent;
        border-radius: 2px;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0 2px;
    }

    .post-text .spoiler:hover,
    .post-text .spoiler.revealed {
        background-color: var(--color-surface-dim);
        color: var(--color-text-base);
    }

    html.dark .post-text .spoiler {
        background-color: var(--color-text-dark);
    }

    html.dark .post-text .spoiler:hover,
    html.dark .post-text .spoiler.revealed {
        background-color: var(--color-surface-dark-dim);
        color: var(--color-text-dark);
    }

    /* ============================================================
     REACTIONS
     ============================================================ */
    .post-reactions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .reaction {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.35rem 0.65rem;
        background-color: var(--color-surface-dim);
        border-radius: 1rem;
        border: 1px solid var(--color-border);
        font-size: 0.8125rem;
    }

    html.dark .reaction {
        background-color: var(--color-surface-dark-dim);
        border-color: var(--color-border-dark);
    }

    .reaction-emoji {
        font-size: 1rem;
    }

    .reaction-count {
        font-weight: 600;
        color: var(--color-text-muted);
    }

    html.dark .reaction-count {
        color: var(--color-text-dark-muted);
    }

    /* ============================================================
     FOOTER
     ============================================================ */
    .post-footer {
        padding-top: 0.75rem;
        border-top: 1px solid var(--color-border);
    }

    html.dark .post-footer {
        border-color: var(--color-border-dark);
    }

    .view-telegram {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #0088cc;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .view-telegram:hover {
        color: #006699;
        text-decoration: underline;
    }

    /* ============================================================
     RESPONSIVE
     ============================================================ */
    @media (max-width: 640px) {
        .telegram-feed {
            padding: 1rem;
        }

        .post-card {
            padding: 1rem;
        }

        .post-badges {
            gap: 0.35rem;
        }

        .post-badge {
            font-size: 0.6875rem;
            padding: 0.2rem 0.5rem;
        }

        .post-meta {
            gap: 0.75rem;
            font-size: 0.75rem;
        }

        .media-photo.single img {
            max-height: 350px;
        }

        .media-video video,
        .media-video-preview img {
            max-height: 300px;
        }

        .media-round-video,
        .media-round-video-preview {
            width: 150px;
            height: 150px;
        }

        .lp-thumb {
            width: 60px;
            height: 60px;
        }

        .poll-option {
            padding: 0.5rem;
        }

        .poll-option-text {
            font-size: 0.8125rem;
        }
    }
</style>
