---
/**
 * CategoryCard Component
 *
 * Displays a category with icon, item count, and top items.
 * Clicking the card filters the list view by category.
 */

import type { Category } from '../data/categories';

interface Props {
  category: Category;
  items: any[];
  lang: 'fa' | 'en';
  contentType: 'articles' | 'books' | 'statements';
}

const { category, items, lang, contentType } = Astro.props;

// Get category name based on language
const categoryName = lang === 'fa' ? category.nameFa : category.nameEn;
const categoryDescription = lang === 'fa' ? category.descriptionFa : category.descriptionEn;

// Get top 3 most recent or popular items
const topItems = items
  .sort((a, b) => {
    // Sort by date (most recent first)
    const dateA = new Date(a.data.publishDate || a.data.updatedDate || 0);
    const dateB = new Date(b.data.publishDate || b.data.updatedDate || 0);
    return dateB.getTime() - dateA.getTime();
  })
  .slice(0, 3);

// Build filter URL - link to list view with category filter hash
const baseUrl = lang === 'fa' ? `/${contentType}` : `/en/${contentType}`;
const filterUrl = `${baseUrl}#list&category=${encodeURIComponent(category.slug)}`;

// Helper to get item URL
function getItemUrl(item: any) {
  const slug = item.id.replace(/\.(md|mdx)$/, '').replace(/^(fa|en)\//, '');
  return lang === 'fa' ? `/${contentType}/${slug}` : `/en/${contentType}/${slug}`;
}
---

<div
  class="category-card group relative p-5 rounded-xl border-2 border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-all duration-200 hover:shadow-lg cursor-pointer"
  data-category={category.slug}
  data-filter-url={filterUrl}
>
  <!-- Header with Icon and Count -->
  <div class="flex items-start justify-between mb-3">
    <div class="flex-1">
      <div class="flex items-center gap-2 mb-2">
        <!-- Category Icon -->
        <div class="w-10 h-10 flex-shrink-0 text-primary dark:text-primary-light opacity-70 group-hover:opacity-100 transition-opacity">
          <img
            src={category.imagePath}
            alt={categoryName}
            class="w-full h-full object-contain"
            loading="lazy"
          />
        </div>

        <!-- Category Name -->
        <h3 class="text-base font-bold text-text dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors">
          {categoryName}
        </h3>
      </div>

      <!-- Category Description -->
      {categoryDescription && (
        <p class="text-xs text-text-muted dark:text-text-dark-muted line-clamp-1 mb-2">
          {categoryDescription}
        </p>
      )}
    </div>

    <!-- Item Count Badge -->
    <div class="flex-shrink-0 ms-3">
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary dark:bg-primary-light/10 dark:text-primary-light">
        {items.length}
      </span>
    </div>
  </div>

  <!-- Top Items List - Compact -->
  {topItems.length > 0 && (
    <div class="space-y-1.5 pt-3 border-t border-border dark:border-border-dark">
      <p class="text-xs font-medium text-text-muted dark:text-text-dark-muted mb-2">
        {lang === 'fa' ? 'آخرین مطالب:' : 'Recent:'}
      </p>
      {topItems.map((item) => (
        <a
          href={getItemUrl(item)}
          class="item-link flex items-start gap-1.5 text-xs hover:translate-x-1 transition-transform no-underline"
          data-item-link="true"
        >
          <svg class="w-3 h-3 flex-shrink-0 mt-0.5 text-primary dark:text-primary-light opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="line-clamp-1 text-text-muted dark:text-text-dark-muted hover:text-primary dark:hover:text-primary-light transition-colors">
            {item.data.title}
          </span>
        </a>
      ))}
    </div>
  )}

  <!-- View All Link -->
  <div class="mt-3 pt-2 border-t border-border dark:border-border-dark">
    <span class="text-xs font-medium text-primary dark:text-primary-light group-hover:underline inline-flex items-center gap-1">
      {lang === 'fa' ? 'مشاهده همه' : 'View all'}
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={lang === 'fa' ? "M15 19l-7-7 7-7" : "M9 5l7 7-7 7"} />
      </svg>
    </span>
  </div>
</div>

<script>
  // Handle category card clicks
  document.addEventListener('DOMContentLoaded', () => {
    const cards = document.querySelectorAll('.category-card');

    cards.forEach((card) => {
      card.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;

        // Don't navigate if clicking on an item link
        if (target.closest('[data-item-link]')) {
          return; // Let the item link handle navigation
        }

        // Navigate to filtered list view
        const filterUrl = card.getAttribute('data-filter-url');
        if (filterUrl) {
          window.location.href = filterUrl;
        }
      });
    });
  });
</script>

<style>
  .category-card {
    position: relative;
  }

  .category-card:hover {
    transform: translateY(-2px);
  }

  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
