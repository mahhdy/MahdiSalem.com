---

---

<div
    class="mdx-tabs my-6 border border-border dark:border-border-dark rounded-lg bg-surface dark:bg-surface-dark overflow-hidden"
>
    <div
        class="tabs-header flex overflow-x-auto border-b border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim"
    >
        <!-- Buttons will be injected here by client-side script -->
    </div>
    <div class="tabs-content" style="position: relative; padding: 1rem;">
        <slot />
    </div>
</div>

<script>
    /**
     * Tab setup runs AFTER Mermaid has rendered all diagrams.
     * Sequence:
     *   1. Page loads → all .tab-panel are visible (no inline display:none)
     *   2. Mermaid.run() renders all .mermaid blocks (both tabs visible = correct SVG)
     *   3. This script hides inactive tabs AFTER mermaid is done
     */
    function setupTabs() {
        const tabContainers = document.querySelectorAll(".mdx-tabs");

        tabContainers.forEach((container) => {
            const header = container.querySelector(
                ".tabs-header",
            ) as HTMLElement;
            const panels = container.querySelectorAll(
                ".tab-panel",
            ) as NodeListOf<HTMLElement>;

            // Prevent double init
            if (!header || header.children.length > 0) return;
            if (!panels.length) return;

            const showPanel = (p: HTMLElement) => {
                p.style.display = "block";
            };

            const hidePanel = (p: HTMLElement) => {
                p.style.display = "none";
            };

            panels.forEach((panel, index) => {
                const title =
                    panel.getAttribute("data-label") || `Tab ${index + 1}`;
                const btn = document.createElement("button");

                btn.className =
                    "px-5 py-3 text-sm font-medium transition-colors whitespace-nowrap focus:outline-none";

                const setActive = () => {
                    btn.classList.add(
                        "text-primary",
                        "dark:text-primary-light",
                        "bg-surface",
                        "dark:bg-surface-dark",
                        "border-b-2",
                        "border-primary",
                        "dark:border-primary-light",
                    );
                    btn.classList.remove(
                        "text-text-muted",
                        "dark:text-text-dark-muted",
                        "hover:bg-black/5",
                        "dark:hover:bg-white/5",
                    );
                };
                const setInactive = () => {
                    btn.classList.remove(
                        "text-primary",
                        "dark:text-primary-light",
                        "bg-surface",
                        "dark:bg-surface-dark",
                        "border-b-2",
                        "border-primary",
                        "dark:border-primary-light",
                    );
                    btn.classList.add(
                        "text-text-muted",
                        "dark:text-text-dark-muted",
                        "hover:bg-black/5",
                        "dark:hover:bg-white/5",
                        "border-b-2",
                        "border-transparent",
                    );
                };

                // First tab = active, rest hidden
                // NOTE: We DON'T hide yet — we defer until after Mermaid renders.
                if (index === 0) {
                    setActive();
                } else {
                    setInactive();
                }

                btn.textContent = title;
                btn.addEventListener("click", () => {
                    // Reset all
                    const allBtns = header.querySelectorAll("button");
                    allBtns.forEach((b, i) => {
                        b.classList.remove(
                            "text-primary",
                            "dark:text-primary-light",
                            "bg-surface",
                            "dark:bg-surface-dark",
                            "border-primary",
                            "dark:border-primary-light",
                        );
                        b.classList.add(
                            "text-text-muted",
                            "dark:text-text-dark-muted",
                            "border-transparent",
                        );
                        hidePanel(panels[i]);
                    });

                    // Set this tab active
                    setActive();
                    showPanel(panel);
                });

                header.appendChild(btn);
            });

            // Now hide all panels except the first.
            // This runs AFTER Mermaid has rendered (because we use a delay).
            panels.forEach((panel, index) => {
                if (index !== 0) hidePanel(panel);
            });
        });
    }

    /**
     * Wait for Mermaid to finish rendering before setting up tabs.
     * Mermaid.run() is called at DOMContentLoaded in BaseLayout.astro,
     * so we schedule our tab setup ~500ms after to be safe.
     */
    function deferredSetupTabs() {
        // If mermaid exists, wait for it to finish
        if (typeof (window as any).mermaid !== "undefined") {
            // Mermaid.run() returns a promise; we hook after it
            const checkInterval = setInterval(() => {
                // Check if mermaid diagrams have been processed (have SVG children)
                const mermaidEls =
                    document.querySelectorAll(".mdx-tabs .mermaid");
                let allProcessed = true;
                mermaidEls.forEach((el) => {
                    if (
                        !el.querySelector("svg") &&
                        !el.getAttribute("data-processed")
                    ) {
                        allProcessed = false;
                    }
                });
                if (allProcessed || mermaidEls.length === 0) {
                    clearInterval(checkInterval);
                    setupTabs();
                }
            }, 100);
            // Fallback: after 3 seconds, set up tabs anyway
            setTimeout(() => {
                clearInterval(checkInterval);
                setupTabs();
            }, 3000);
        } else {
            // No mermaid on page — set up immediately
            setupTabs();
        }
    }

    document.addEventListener("DOMContentLoaded", deferredSetupTabs);
    document.addEventListener("astro:page-load", deferredSetupTabs);
</script>
