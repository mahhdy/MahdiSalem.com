---
import { t } from '../i18n';
import ratings from '../data/ratings.json';

interface Props {
  contentId: string;
  lang: 'fa' | 'en';
}

const { contentId, lang } = Astro.props;
const rating = ratings[contentId] || { average: 0, count: 0 };
const numFormatter = new Intl.NumberFormat(lang === 'fa' ? 'fa-IR' : 'en-US');
---

<div class="rating-container my-6 p-4 rounded-xl bg-surface-dim dark:bg-surface-dark-dim border border-border dark:border-border-dark" data-content-id={contentId}>
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <div class="flex text-amber-500">
        {[1, 2, 3, 4, 5].map((star) => (
          <svg
            class={`w-5 h-5 ${star <= Math.round(rating.average) ? 'fill-current' : 'text-gray-300 dark:text-gray-600 fill-none stroke-current'}`}
            viewBox="0 0 24 24"
            stroke-width="1.5"
          >
            <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
          </svg>
        ))}
      </div>
      <span class="text-sm font-bold">
        {numFormatter.format(rating.average)} {t('rating.out_of', lang)}
      </span>
      <span class="text-xs text-text-muted dark:text-text-dark-muted">
        ({numFormatter.format(rating.count)} {t('rating.votes', lang)})
      </span>
    </div>

    <button class="rate-btn text-xs font-medium px-4 py-1.5 rounded-full border border-primary text-primary hover:bg-primary/5 transition-colors">
      {t('rating.submit', lang)}
    </button>
  </div>

  <!-- Rating Interaction (Hidden by default) -->
  <div class="rating-interaction hidden mt-4 pt-4 border-t border-border/50 dark:border-border-dark/50">
    <div class="flex items-center gap-2 mb-4">
      {[1, 2, 3, 4, 5].map((i) => (
        <button class="star-input group" data-value={i}>
          <svg class="w-8 h-8 text-gray-300 dark:text-gray-600 group-hover:text-amber-400 pointer-events-none transition-colors" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z" />
          </svg>
        </button>
      ))}
    </div>
    <p class="success-msg hidden text-xs text-green-600 dark:text-green-400 font-medium">
      {t('rating.thank_you', lang)}
    </p>
  </div>
</div>

<script>
  const containers = document.querySelectorAll('.rating-container');
  containers.forEach(container => {
    const rateBtn = container.querySelector('.rate-btn');
    const interaction = container.querySelector('.rating-interaction');
    const stars = container.querySelectorAll('.star-input');
    const successMsg = container.querySelector('.success-msg');
    const contentId = container.getAttribute('data-content-id');

    // Check if already rated (localStorage simulation)
    if (localStorage.getItem(`rated_${contentId}`)) {
      if (rateBtn) (rateBtn as HTMLElement).style.display = 'none';
    }

    rateBtn?.addEventListener('click', () => {
      interaction?.classList.toggle('hidden');
    });

    stars.forEach(star => {
      star.addEventListener('click', () => {
        const val = star.getAttribute('data-value');
        localStorage.setItem(`rated_${contentId}`, val || 'true');
        
        // Visual feedback
        stars.forEach(s => (s as HTMLElement).style.opacity = '0.5');
        (star as HTMLElement).style.opacity = '1';
        (star as HTMLElement).classList.add('text-amber-500');
        
        successMsg?.classList.remove('hidden');
        setTimeout(() => {
          interaction?.classList.add('hidden');
          if (rateBtn) (rateBtn as HTMLElement).style.display = 'none';
        }, 1500);
      });
      
      star.addEventListener('mouseenter', () => {
        const val = parseInt(star.getAttribute('data-value') || '0');
        stars.forEach((s, i) => {
          if (i < val) s.querySelector('svg')?.classList.add('text-amber-400');
        });
      });
      
      star.addEventListener('mouseleave', () => {
        stars.forEach(s => s.querySelector('svg')?.classList.remove('text-amber-400'));
      });
    });
  });
</script>
