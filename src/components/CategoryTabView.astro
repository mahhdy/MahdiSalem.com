---
/**
 * CategoryTabView Component
 *
 * Provides tabbed interface for viewing content as list or by categories.
 * Defaults to category view per user preference.
 */

import CategoryCard from "./CategoryCard.astro";
import { getCategoriesByContentType } from "../data/categories";

interface Props {
  contentType: "articles" | "books" | "statements" | "multimedia";
  lang: "fa" | "en";
  allItems: any[];
  defaultTab?: "list" | "categories";
}

const { contentType, lang, allItems, defaultTab } = Astro.props;

// Filter categories relevant to this content type
const relevantCategories = getCategoriesByContentType(contentType);

// Group items by category
const categorizedItems = new Map<string, any[]>();

relevantCategories.forEach((category) => {
  const items = allItems.filter((item) => {
    // Primary: use the interface field (new taxonomy system)
    if (item.data.interface) {
      return item.data.interface === category.slug;
    }

    // Fallback: check old categories array for backward compatibility
    const itemCategories = item.data.categories || [];
    return itemCategories.some((cat: string) => {
      return (
        cat === category.slug ||
        cat === category.nameFa ||
        cat === category.nameEn
      );
    });
  });

  if (items.length > 0) {
    categorizedItems.set(category.slug, items);
  }
});

// Dynamic default: category view when multiple interfaces exist, list view otherwise.
// The passed-in defaultTab prop can override only if explicitly provided.
const effectiveDefault =
  defaultTab ?? (categorizedItems.size > 1 ? "categories" : "list");

// Get i18n labels
const labels = {
  listView: lang === "fa" ? "نمای فهرستی" : "List View",
  categoryView: lang === "fa" ? "نمای دسته‌بندی" : "Category View",
};
---

<div
  class="category-tab-view"
  data-default-tab={effectiveDefault}
  data-category-count={categorizedItems.size}
>
  <!-- Tab Buttons -->
  <div class="flex justify-center mb-8">
    <div
      class="inline-flex p-1 bg-surface-dim dark:bg-surface-dark-dim rounded-lg border border-border dark:border-border-dark"
    >
      <button
        class="tab-btn px-6 py-2.5 rounded-md text-sm font-medium transition-colors"
        data-tab="list"
        type="button"
      >
        {labels.listView}
      </button>
      <button
        class="tab-btn px-6 py-2.5 rounded-md text-sm font-medium transition-colors"
        data-tab="categories"
        type="button"
      >
        {labels.categoryView}
      </button>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content-container">
    <!-- List View (slot content) -->
    <div id="list-content" class="tab-content">
      <slot />
    </div>

    <!-- Category View -->
    <div id="categories-content" class="tab-content">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {
          Array.from(categorizedItems.entries()).map(([slug, items]) => {
            const category = relevantCategories.find((c) => c.slug === slug);
            if (!category) return null;

            return (
              <CategoryCard
                category={category}
                items={items}
                lang={lang}
                contentType={contentType}
              />
            );
          })
        }
      </div>

      {
        categorizedItems.size === 0 && (
          <div class="text-center py-16">
            <p class="text-text-muted dark:text-text-dark-muted">
              {lang === "fa"
                ? "هیچ دسته‌بندی‌ای یافت نشد"
                : "No categories found"}
            </p>
          </div>
        )
      }
    </div>
  </div>
</div>

<style>
  .tab-btn {
    color: var(--color-text-muted);
  }

  html.dark .tab-btn {
    color: var(--color-text-dark-muted);
  }

  .tab-btn:hover {
    color: var(--color-text);
  }

  html.dark .tab-btn:hover {
    color: var(--color-text-dark);
  }

  .tab-btn.active {
    background-color: white;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    color: var(--color-primary);
  }

  html.dark .tab-btn.active {
    background-color: var(--color-surface-dark);
    color: var(--color-primary-light);
  }

  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }
</style>

<script>
  function initCategoryTabViews() {
    const tabViews = document.querySelectorAll(".category-tab-view");

    tabViews.forEach((tabView) => {
      const buttons = tabView.querySelectorAll<HTMLButtonElement>(".tab-btn");
      const listContent = tabView.querySelector("#list-content");
      const categoriesContent = tabView.querySelector("#categories-content");

      const activateTab = (tab: string, updateUrl = true) => {
        buttons.forEach((btn) => btn.classList.remove("active"));
        const activeBtn = tabView.querySelector(`[data-tab="${tab}"]`);
        if (activeBtn) activeBtn.classList.add("active");

        if (listContent && categoriesContent) {
          if (tab === "list") {
            listContent.classList.add("active");
            categoriesContent.classList.remove("active");
          } else {
            categoriesContent.classList.add("active");
            listContent.classList.remove("active");
          }
        }

        if (updateUrl) {
          const url = new URL(window.location.href);
          if (url.searchParams.get("view") !== tab) {
            url.searchParams.set("view", tab);
            window.history.replaceState(
              null,
              "",
              `${url.pathname}${url.search}`,
            );
          }
        }
      };

      // Determine initial tab from URL or default
      const params = new URLSearchParams(window.location.search);
      const queryView = params.get("view");
      const interfaceParam = params.get("interface");
      const hashView = window.location.hash.replace("#", "");
      const defaultTab = tabView.getAttribute("data-default-tab") || "list";

      let initialTab = defaultTab;
      if (queryView === "list" || queryView === "categories") {
        initialTab = queryView;
      } else if (interfaceParam) {
        initialTab = "list";
      } else if (hashView === "list" || hashView === "categories") {
        initialTab = hashView;
      }

      // Initialize the UI state
      activateTab(initialTab, false);

      // Add click handlers
      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const tab = button.getAttribute("data-tab") || "list";
          activateTab(tab);
        });
      });

      // Apply ?interface= filter in list view
      if (interfaceParam && listContent) {
        const applyInterfaceFilter = () => {
          const filterBtn = listContent.querySelector<HTMLButtonElement>(
            `.category-filter[data-category="${interfaceParam}"]`,
          );
          if (filterBtn) {
            filterBtn.click();
          }
        };
        applyInterfaceFilter();
        setTimeout(applyInterfaceFilter, 50);
        setTimeout(applyInterfaceFilter, 200);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", initCategoryTabViews);
  document.addEventListener("astro:after-swap", initCategoryTabViews);
  document.addEventListener("astro:page-load", initCategoryTabViews);
</script>
