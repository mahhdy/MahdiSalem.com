---
/**
 * TelegramFeedCompact ‚Äî 2-column grid view for the homepage.
 * Features: Rich parsing (threads, albums, etc.) with the Original look & feel.
 */
import { t } from "../i18n";
import type { Locale } from "../i18n";

interface Props {
  lang: Locale;
  limit?: number;
}

const { lang, limit = 6 } = Astro.props;

const workerUrl =
  import.meta.env.PUBLIC_TELEGRAM_WORKER_URL ||
  "https://telegram-feed.mahhdy.workers.dev";
const channelUsername = import.meta.env.PUBLIC_TELEGRAM_CHANNEL || "@mahhdy57";
---

<div
  class="telegram-compact-feed p-6 rounded-2xl bg-[#f8fafc] dark:bg-[#0f172a] border border-border dark:border-border-dark"
  data-worker-url={workerUrl}
  data-limit={limit}
  data-lang={lang}
  dir={lang === "fa" ? "rtl" : "ltr"}
>
  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <h2 class="text-xl font-bold flex items-center gap-2">
      <svg
        class="w-6 h-6 text-[#0088cc]"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"
        ></path>
      </svg>
      {t("telegram.latest_posts", lang)}
    </h2>
    <a
      href="/social#telegram"
      class="text-sm text-[#0088cc] font-medium hover:underline"
    >
      {lang === "fa" ? "ŸÖÿ¥ÿßŸáÿØŸá ŸáŸÖŸá" : "View All"} ‚Üí
    </a>
  </div>

  <!-- Loading -->
  <div class="feed-loading py-12 flex flex-col items-center justify-center">
    <div
      class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#0088cc] mb-4"
    >
    </div>
  </div>

  <!-- Error -->
  <div class="feed-error hidden py-12 text-center text-red-500 text-sm">
    {t("telegram.error", lang)}
  </div>

  <!-- Grid -->
  <div class="compact-grid grid grid-cols-1 sm:grid-cols-2 gap-5">
    <!-- Cards injected by JS -->
  </div>

  <!-- Footer link -->
  <div class="mt-8 text-center pt-6 border-t border-border/50">
    <a
      href={`https://t.me/${channelUsername.replace("@", "")}`}
      target="_blank"
      rel="noopener"
      class="inline-flex items-center gap-2 text-[#0088cc] font-bold hover:underline"
    >
      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"
        ><path
          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.11.02-1.89 1.2-5.33 3.52-.5.35-.96.52-1.37.51-.45-.01-1.32-.26-1.97-.47-.79-.26-1.42-.4-1.36-.85.03-.23.35-.47.94-.71 3.69-1.61 6.15-2.67 7.39-3.19 3.52-1.47 4.25-1.73 4.73-1.74.1 0 .33.02.48.15.12.11.16.26.18.39l.06.33z"
        ></path></svg
      >
      {t("telegram.view_channel", lang)}
    </a>
  </div>
</div>

<script>
  interface MediaItem {
    type: string;
    url?: string;
    thumbnail?: string;
  }

  interface TelegramPost {
    id: string;
    text: string;
    textHtml?: string;
    date: number;
    views: number;
    link: string;
    media?: MediaItem[];
    threadPart?: { current: number; total: number | null };
    edited?: boolean;
    replyTo?: any;
  }

  function escapeHtml(str: string): string {
    return (str || "").replace(
      /[&<>"']/g,
      (m) =>
        ({
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#039;",
        })[m],
    );
  }

  function buildCompactCard(
    post: TelegramPost,
    lang: "fa" | "en",
  ): HTMLElement {
    const card = document.createElement("div");
    card.className =
      "compact-card bg-white dark:bg-slate-900 border border-border dark:border-border-dark p-4 rounded-xl shadow-sm hover:shadow-md transition-all flex flex-col cursor-pointer";
    card.setAttribute("dir", lang === "fa" ? "rtl" : "ltr");
    card.onclick = () => window.open(post.link, "_blank");

    // Meta - Date & Views at Top
    const date = new Intl.DateTimeFormat(lang === "fa" ? "fa-IR" : "en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
      hour: "2-digit",
      minute: "2-digit",
    }).format(new Date(post.date * 1000));
    const views = post.views.toLocaleString(lang === "fa" ? "fa-IR" : "en-US");

    let html = `
      <div class="flex items-center justify-between text-[10px] text-text-muted mb-3 opacity-70 font-bold uppercase tracking-wider">
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          ${date}
        </span>
        <span class="flex items-center gap-1">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
          ${views}
        </span>
      </div>
    `;

    // Thumbnail
    const thumb = post.media?.find((m) => m.thumbnail || m.url);
    if (thumb) {
      html += `<img src="${thumb.thumbnail || thumb.url}" class="w-full h-32 object-cover rounded-lg mb-3" loading="lazy" />`;
    }

    // Reply indicator (Grey Area)
    if (post.replyTo) {
      html += `
        <div class="bg-slate-100 dark:bg-slate-800 border-r-2 border-[#0088cc] px-2 py-1 rounded text-[10px] text-text-muted mb-2 line-clamp-1">
          ‚Ü©Ô∏è ${lang === "fa" ? "Ÿæÿßÿ≥ÿÆ" : "Reply"}
        </div>
      `;
    }

    // 6. MAIN TEXT (White Area)
    let plainText = post.text || "";
    if (plainText.trim().startsWith("##")) {
      const lines = plainText.split("\n");
      lines.shift();
      plainText = lines.join("\n").trim();
    }
    const content = escapeHtml(plainText);
    html += `<div class="text-sm line-clamp-4 text-text-base dark:text-text-dark leading-relaxed mb-3 flex-1 post-content-compact whitespace-pre-wrap">${content}</div>`;

    // Badges / Footer
    html += `
      <div class="flex items-center justify-between mt-auto pt-2 border-t border-border/30">
        <div class="flex gap-1">
          ${post.threadPart ? `<span class="bg-[#0088cc15] text-[#0088cc] text-[9px] px-1.5 py-0.5 rounded font-bold uppercase tracking-tighter">üìë Part ${post.threadPart.current}</span>` : ""}
          ${post.media && post.media.length > 1 ? `<span class="bg-emerald-500/10 text-emerald-600 text-[9px] px-1.5 py-0.5 rounded font-bold uppercase tracking-tighter">üì∑ Album</span>` : ""}
        </div>
        <span class="text-[#0088cc] text-xs font-bold">‚Üó</span>
      </div>
    `;

    card.innerHTML = html;
    return card;
  }

  document
    .querySelectorAll(".telegram-compact-feed")
    .forEach(async (container) => {
      const workerUrl = container.getAttribute("data-worker-url");
      const limit = parseInt(container.getAttribute("data-limit") || "6");
      const lang = container.getAttribute("data-lang") as "fa" | "en";
      const gridEl = container.querySelector(".compact-grid");

      if (!workerUrl) return;

      try {
        const resp = await fetch(workerUrl);
        if (!resp.ok) throw new Error();
        const posts: TelegramPost[] = await resp.json();

        container.querySelector(".feed-loading")?.classList.add("hidden");
        if (!posts || posts.length === 0) throw new Error();

        posts.slice(0, limit).forEach((post) => {
          gridEl?.appendChild(buildCompactCard(post, lang));
        });
      } catch (e) {
        container.querySelector(".feed-loading")?.classList.add("hidden");
        container.querySelector(".feed-error")?.classList.remove("hidden");
      }
    });
</script>

<style>
  .telegram-compact-feed {
    box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
  }
</style>
