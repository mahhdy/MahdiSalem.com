---
/**
 * LinkedInFeed Component
 * Displays the latest posts from LinkedIn via RSS.app XML feed
 */
import { siteConfig } from "../config/site";

interface Props {
    lang: "fa" | "en";
}

const { lang } = Astro.props;
const { feedIds, feedLimits } = siteConfig;
const id = feedIds.linkedin;
// RSS.app uses similar URL structure for LinkedIn
const feedUrl = id ? `https://rss.app/feeds/${id}.xml` : "";
const limit = feedLimits.linkedin || 10;

const t = {
    fa: {
        latest_posts: "جدیدترین پست‌های لینکدین (LinkedIn)",
        loading: "در حال بارگذاری...",
        error: "خطا در بارگذاری فید لینکدین",
        view_profile: "مشاهده پروفایل در لینکدین",
        no_posts: "پستی یافت نشد",
    },
    en: {
        latest_posts: "Latest LinkedIn Posts",
        loading: "Loading...",
        error: "Error loading LinkedIn feed",
        view_profile: "View Profile on LinkedIn",
        no_posts: "No posts found",
    },
}[lang];
---

<div
    class="linkedin-feed"
    data-feed-url={feedUrl}
    data-limit={limit}
    data-lang={lang}
    dir={lang === "fa" ? "rtl" : "ltr"}
>
    <!-- Header -->
    <div class="feed-header flex items-center justify-between mb-8">
        <h2 class="text-2xl font-bold flex items-center gap-3">
            <svg
                class="w-7 h-7 text-[#0A66C2]"
                fill="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 1 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                ></path>
            </svg>
            {t.latest_posts}
        </h2>
    </div>

    <!-- Loading -->
    <div
        class="feed-loading py-20 flex flex-col items-center justify-center text-text-muted"
    >
        <div
            class="animate-spin rounded-full h-10 w-10 border-b-2 border-[#0A66C2] mb-4"
        >
        </div>
        <p>{t.loading}</p>
    </div>

    <!-- Error -->
    <div class="feed-error hidden py-20 text-center text-red-500">
        <p>{t.error}</p>
    </div>

    <!-- Posts Container -->
    <div class="feed-posts space-y-6">
        <!-- Items Injected here -->
    </div>

    <!-- Footer link -->
    <div class="feed-footer text-center mt-12 hidden">
        <a
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-6 py-3 rounded-lg border border-border dark:border-border-dark hover:border-[#0A66C2] transition-all font-medium"
        >
            {t.view_profile}
        </a>
    </div>
</div>

<script>
    document.querySelectorAll(".linkedin-feed").forEach(async (container) => {
        const feedUrl = container.getAttribute("data-feed-url");
        const limit = parseInt(container.getAttribute("data-limit") || "10");
        const lang = container.getAttribute("data-lang");

        if (!feedUrl) return;

        const loadingEl = container.querySelector(
            ".feed-loading",
        ) as HTMLElement;
        const errorEl = container.querySelector(".feed-error") as HTMLElement;
        const postsEl = container.querySelector(".feed-posts") as HTMLElement;
        const footerEl = container.querySelector(".feed-footer") as HTMLElement;

        try {
            const response = await fetch(feedUrl);
            if (!response.ok) throw new Error();
            const text = await response.text();

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(text, "text/xml");
            const items = xmlDoc.querySelectorAll("item");

            loadingEl.classList.add("hidden");

            if (items.length === 0) {
                errorEl.classList.remove("hidden");
                errorEl.textContent =
                    lang === "fa" ? "پستی یافت نشد" : "No posts found";
                return;
            }

            const channelLink =
                xmlDoc.querySelector("channel > link")?.textContent;
            if (channelLink) {
                const profileLink = footerEl.querySelector(
                    "a",
                ) as HTMLAnchorElement;
                profileLink.href = channelLink;
                footerEl.classList.remove("hidden");
            }

            Array.from(items)
                .slice(0, limit)
                .forEach((item) => {
                    const title =
                        item.querySelector("title")?.textContent || "";
                    const link = item.querySelector("link")?.textContent || "#";
                    const description =
                        item.querySelector("description")?.textContent || "";
                    const pubDate =
                        item.querySelector("pubDate")?.textContent || "";

                    const date = new Date(pubDate);
                    const formattedDate = date.toLocaleDateString(
                        lang === "fa" ? "fa-IR" : "en-US",
                        {
                            year: "numeric",
                            mouth: "short",
                            day: "numeric",
                        },
                    );

                    const postCard = document.createElement("article");
                    postCard.className =
                        "p-5 rounded-lg bg-surface dark:bg-surface-dark border border-border dark:border-border-dark hover:border-[#0A66C2] transition-all hover:shadow-md";

                    let mediaHtml = "";
                    const imgMatch = description.match(
                        /<img[^>]+src="([^">]+)"/,
                    );
                    if (imgMatch) {
                        mediaHtml = `<img src="${imgMatch[1]}" class="rounded-lg mb-4 max-h-96 w-auto object-cover" loading="lazy" />`;
                    }

                    const cleanDesc = description
                        .replace(/<[^>]*>/g, "")
                        .trim();

                    postCard.innerHTML = `
                    <div class="flex items-center gap-2 mb-3 text-sm text-text-muted">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>${formattedDate}</span>
                    </div>
                    ${mediaHtml}
                    <div class="post-text mb-4 text-text-base dark:text-text-dark leading-relaxed whitespace-pre-wrap">${cleanDesc || title}</div>
                    <a href="${link}" target="_blank" rel="noopener noreferrer" class="text-[#0A66C2] hover:underline text-sm font-medium">
                        ${lang === "fa" ? "مشاهده در لینکدین" : "View on LinkedIn"} →
                    </a>
                `;
                    postsEl.appendChild(postCard);
                });
        } catch (e) {
            console.error("LinkedIn feed error:", e);
            loadingEl.classList.add("hidden");
            errorEl.classList.remove("hidden");
        }
    });
</script>
