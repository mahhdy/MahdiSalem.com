---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CategoryTabView from '../../components/CategoryTabView.astro';
import { t, stripLangPrefix } from '../../i18n';
import { getCollection } from 'astro:content';
import { getCategoryName, getCategoriesByContentType } from '../../data/categories';
import stats from '../../data/stats.json';
import ratings from '../../data/ratings.json';

const lang = 'fa';
const statsVisits = stats.visits as Record<string, number>;
const ratingsMap = ratings as Record<string, { average?: number; count?: number }>;

const allBooks = await getCollection('books', (entry) => {
  return entry.data.lang === 'fa' && entry.id.split('/').length === 2;
});

// Pre-process books with stats and ratings
const books = allBooks.map(b => {
  const path = b.id.replace(/\.md$/, '').replace(/^content\//, '');
  return {
    ...b,
    visits: statsVisits[path] || 0,
    rating: ratingsMap[path]?.average || 0,
    votes: ratingsMap[path]?.count || 0
  };
}).sort((a, b) => a.data.order - b.data.order);

const allInterfaces = [...new Set(books.map((b) => b.data.interface).filter((value): value is string => Boolean(value)))];
const relevantCategories = getCategoriesByContentType('books');
const availableInterfaces = allInterfaces.filter((iface) => relevantCategories.some((cat) => cat.slug === iface));
---

<BaseLayout title={t('nav.books', lang)}>
  <div class="container-wide py-16">
    <h1 class="text-3xl font-bold mb-8 text-center">{t('nav.books', lang)}</h1>

    <CategoryTabView contentType="books" lang={lang} allItems={books} defaultTab="categories">
    <div class="flex flex-col md:flex-row gap-6 mb-8">
      {/* Search */}
      <div class="flex-1 relative">
        <input 
          type="text" 
          id="search-input" 
          placeholder={t('search.placeholder', lang)}
          class="w-full pl-10 pr-4 py-2 rounded-lg border border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim focus:ring-2 focus:ring-primary outline-none transition-all"
        />
        <svg class="absolute left-3 top-2.5 w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </div>

      {/* Sort */}
      <div class="flex items-center gap-2">
        <label for="sort-select" class="text-sm font-medium whitespace-nowrap">{t('sort.label', lang)}:</label>
        <select id="sort-select" class="px-3 py-2 rounded-lg border border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim outline-none focus:ring-2 focus:ring-primary">
          <option value="order">ترتیب اصلی</option>
          <option value="popular">{t('sort.popular', lang)}</option>
          <option value="rating">{t('sort.rating', lang)}</option>
        </select>
      </div>
    </div>

    {availableInterfaces.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8">
        <button class="category-filter active text-sm px-3 py-1.5 rounded-full border border-primary text-primary dark:border-primary-light dark:text-primary-light font-medium" data-category="all">
          همه
        </button>
        {availableInterfaces.map((slug) => (
          <button class="category-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors" data-category={slug}>
            {getCategoryName(slug, lang)}
          </button>
        ))}
      </div>
    )}

    {books.length > 0 ? (
      <div id="books-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {books.map((book) => (
          <a
            href={`/books/${stripLangPrefix(book.id).replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '')}`}
            class={`book-card group block rounded-xl border ${book.data.draft ? 'border-dashed border-amber-300 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/10' : 'border-border dark:border-border-dark'} hover:border-blue-500 dark:hover:border-blue-400 transition-colors no-underline overflow-hidden`}
            data-title={book.data.title.toLowerCase()}
            data-desc={book.data.description.toLowerCase()}
            data-interface={book.data.interface || 'unknown'}
            data-visits={book.visits}
            data-rating={book.rating}
            data-order={book.data.order}
          >
            {book.data.coverImage && (
              <img src={book.data.coverImage} alt={book.data.title} class="w-full h-56 object-cover" loading="lazy" />
            )}
            <div class="p-6">
              <div class="flex justify-between items-start gap-4 mb-2">
                <h2 class="text-xl font-bold text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors">
                  {book.data.title}
                </h2>
                {book.rating > 0 && (
                  <div class="flex items-center gap-1 text-amber-500 text-xs font-bold shrink-0 pt-1">
                    <svg class="w-3 h-3 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    <span>{book.rating.toFixed(1)}</span>
                  </div>
                )}
              </div>
              <p class="text-sm text-text-muted dark:text-text-dark-muted mb-4 line-clamp-2">
                {book.data.description}
              </p>
              <div class="flex items-center justify-between">
                <div class="flex gap-3">
                  <span class="text-sm text-primary dark:text-primary-light font-medium">
                    {t('books.read_online', lang)}
                  </span>
                  {book.data.pdfUrl && (
                    <span class="text-sm text-secondary font-medium">
                      {t('books.download_pdf', lang)}
                    </span>
                  )}
                </div>
                <span class="text-[10px] opacity-60">{book.visits.toLocaleString('fa-IR')} بازدید</span>
              </div>
            </div>
          </a>
        ))}
      </div>

    ) : (
      <p class="text-text-muted dark:text-text-dark-muted">به زودی کتاب‌ها در این بخش منتشر خواهند شد.</p>
    )}

<script>
  const filters = document.querySelectorAll('.category-filter');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  const container = document.getElementById('books-container');
  const cards = Array.from(document.querySelectorAll('.book-card')) as HTMLElement[];

  const params = new URLSearchParams(window.location.search);
  const initialInterface = params.get('interface') || 'all';

  let activeCategory = 'all';
  let searchTerm = '';

  function syncUrl() {
    const url = new URL(window.location.href);
    url.searchParams.set('view', 'list');

    if (activeCategory === 'all') {
      url.searchParams.delete('interface');
    } else {
      url.searchParams.set('interface', activeCategory);
    }

    window.history.replaceState(null, '', `${url.pathname}${url.search}`);
  }

  function update() {
    // 1. Filter
    cards.forEach((card) => {
      const iface = card.getAttribute('data-interface') ?? '';
      const title = card.getAttribute('data-title') ?? '';
      const desc = card.getAttribute('data-desc') ?? '';
      const categoryMatch = activeCategory === 'all' || iface === activeCategory;
      card.style.display = (categoryMatch && (title.includes(searchTerm) || desc.includes(searchTerm))) ? '' : 'none';
    });

    // 2. Sort
    const sortBy = sortSelect.value;
    const visibleCards = cards.filter(c => c.style.display !== 'none');
    
    visibleCards.sort((a, b) => {
      if (sortBy === 'order') return parseInt(a.getAttribute('data-order')!) - parseInt(b.getAttribute('data-order')!);
      if (sortBy === 'popular') return parseInt(b.getAttribute('data-visits')!) - parseInt(a.getAttribute('data-visits')!);
      if (sortBy === 'rating') return parseFloat(b.getAttribute('data-rating')!) - parseFloat(a.getAttribute('data-rating')!);
      return 0;
    });

    visibleCards.forEach(card => container?.appendChild(card));
  }

  filters.forEach((btn) => {
    btn.addEventListener('click', () => {
      activeCategory = btn.getAttribute('data-category') ?? 'all';
      filters.forEach(f => f.classList.remove('active', 'border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium'));
      btn.classList.add('active', 'border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium');
      syncUrl();
      update();
    });
  });

  searchInput?.addEventListener('input', (e) => {
    searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
    update();
  });

  sortSelect?.addEventListener('change', update);

  const initialButton = document.querySelector(`.category-filter[data-category="${initialInterface}"]`) as HTMLButtonElement | null;
  if (initialButton) {
    initialButton.click();
  } else {
    update();
  }
</script>


    </CategoryTabView>
  </div>
</BaseLayout>
