---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BookLayout from '../../layouts/BookLayout.astro';
import { t } from '../../i18n';
import { getCollection, render } from 'astro:content';

const lang = 'fa';
const stripPrefix = (id: string) => id.replace(/^fa\//, '');

export async function getStaticPaths() {
  const strip = (id: string) => id.replace(/^fa\//, '');
  const allBooks = await getCollection('books', ({ data }) => data.lang === 'fa' && !data.draft);

  // Separate book overviews from chapters
  const overviews = allBooks.filter((b) => !b.data.bookSlug);
  const chapters = allBooks.filter((b) => b.data.bookSlug);

  const paths = [];

  // Overview pages: /books/ethical-evaluation
  for (const book of overviews) {
    const bookChapters = chapters
      .filter((c) => c.data.bookSlug === book.id)
      .sort((a, b) => (a.data.chapterNumber ?? 0) - (b.data.chapterNumber ?? 0));

    paths.push({
      params: { slug: strip(book.id) },
      props: { entry: book, chapters: bookChapters, isChapter: false },
    });
  }

  // Chapter pages: /books/ethical-evaluation/ch01-introduction
  for (const chapter of chapters) {
    const bookChapters = chapters
      .filter((c) => c.data.bookSlug === chapter.data.bookSlug)
      .sort((a, b) => (a.data.chapterNumber ?? 0) - (b.data.chapterNumber ?? 0));

    const idx = bookChapters.findIndex((c) => c.id === chapter.id);
    const bookSlugClean = strip(chapter.data.bookSlug!);

    paths.push({
      params: { slug: `${bookSlugClean}/${strip(chapter.id)}` },
      props: {
        entry: chapter,
        chapters: bookChapters,
        isChapter: true,
        prevChapter: idx > 0 ? bookChapters[idx - 1] : undefined,
        nextChapter: idx < bookChapters.length - 1 ? bookChapters[idx + 1] : undefined,
      },
    });
  }

  return paths;
}

const { entry, chapters, isChapter, prevChapter, nextChapter } = Astro.props;
const { Content, headings } = await render(entry);

const bookSlugClean = stripPrefix(entry.data.bookSlug ?? entry.id);

const chapterList = chapters.map((c: any) => ({
  slug: stripPrefix(c.id),
  title: c.data.title,
  chapterNumber: c.data.chapterNumber ?? 0,
}));
---

{isChapter ? (
  <BookLayout
    title={entry.data.title}
    description={entry.data.description}
    lang={lang}
    bookSlug={bookSlugClean}
    chapterNumber={entry.data.chapterNumber}
    chapters={chapterList}
    headings={headings}
    prevChapter={prevChapter ? { slug: stripPrefix(prevChapter.id), title: prevChapter.data.title, chapterNumber: prevChapter.data.chapterNumber ?? 0 } : undefined}
    nextChapter={nextChapter ? { slug: stripPrefix(nextChapter.id), title: nextChapter.data.title, chapterNumber: nextChapter.data.chapterNumber ?? 0 } : undefined}
  >
    <Content />
  </BookLayout>
) : (
  <BaseLayout title={entry.data.title} description={entry.data.description}>
    <div class="container-narrow py-16">
      {entry.data.coverImage && (
        <img src={entry.data.coverImage} alt={entry.data.title} class="w-full max-w-sm mx-auto rounded-xl mb-8" loading="lazy" />
      )}
      <h1 class="text-3xl md:text-4xl font-bold mb-4">{entry.data.title}</h1>
      <p class="text-lg text-text-muted dark:text-text-dark-muted mb-8">{entry.data.description}</p>

      {chapterList.length > 0 && (
        <div class="mb-8">
          <h2 class="text-xl font-bold mb-4">{t('books.toc', lang)}</h2>
          <ol class="space-y-2">
            {chapterList.map((ch: any) => (
              <li>
                <a
                  href={`/books/${bookSlugClean}/${ch.slug}`}
                  class="flex items-center gap-3 p-3 rounded-lg border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline"
                >
                  <span class="text-sm text-text-muted dark:text-text-dark-muted w-8 text-center shrink-0">
                    {ch.chapterNumber}
                  </span>
                  <span class="text-text-base dark:text-text-dark font-medium">{ch.title}</span>
                </a>
              </li>
            ))}
          </ol>
        </div>
      )}

      {entry.data.pdfUrl && (
        <a
          href={entry.data.pdfUrl}
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-secondary text-white font-medium hover:bg-secondary-light transition-colors no-underline"
          download
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          {t('books.download_pdf', lang)}
        </a>
      )}

      <div class="prose mt-8">
        <Content />
      </div>
    </div>
  </BaseLayout>
)}
