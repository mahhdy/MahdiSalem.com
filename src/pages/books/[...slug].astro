---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BookLayout from '../../layouts/BookLayout.astro';
import Rating from '../../components/Rating.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import Giscus from '../../components/Giscus.astro';
import PDFViewer from '../../components/PDFViewer.astro';
import WidthToggle from '../../components/WidthToggle.astro';
import { t, getLocalizedPath, stripLangPrefix } from '../../i18n';
import { getCollection, render } from 'astro:content';

const lang = 'fa';
const stripPrefix = (id: string) => id.replace(/^fa\//, '');

export async function getStaticPaths() {
  const strip = (id: string) => id.replace(/^fa\//, '').replace(/\.(md|mdx)$/, '');
  const allBooks = await getCollection('books', ({ data }) => data.lang === 'fa' && !data.draft);

  const bookMap = new Map();

  // 1. Identify Books & Chapters
  for (const entry of allBooks) {
    const idWithoutExt = entry.id.replace(/\.(md|mdx)$/, '');
    const segments = idWithoutExt.split('/');
    
    // A book root is either:
    // - fa/BookTitle/index
    // - fa/BookTitle (standalone file)
    const isIndex = segments.at(-1) === 'index';
    
    if (isIndex) {
      const bookIdBase = segments.slice(0, -1).join('/');
      if (!bookMap.has(bookIdBase)) {
        bookMap.set(bookIdBase, { entry, chapters: [] });
      } else {
        // If we already had something, index.mdx takes priority as root
        bookMap.get(bookIdBase).entry = entry;
      }
    } else if (segments.length === 2) {
      // Standalone book file: fa/BookTitle
      if (!bookMap.has(idWithoutExt)) {
        bookMap.set(idWithoutExt, { entry, chapters: [] });
      }
    }
  }

  // 2. Assign Chapters
  for (const entry of allBooks) {
    const idWithoutExt = entry.id.replace(/\.(md|mdx)$/, '');
    const segments = idWithoutExt.split('/');
    const isIndex = segments.at(-1) === 'index';

    if (!isIndex && segments.length > 2) {
      // Try to find the parent book
      let parentId = segments.slice(0, -1).join('/');
      if (bookMap.has(parentId)) {
        bookMap.get(parentId).chapters.push(entry);
      }
    }
  }

  const paths = [];

  // 3. Generate paths
  for (const [bookId, { entry, chapters }] of bookMap.entries()) {
    chapters.sort((a: any, b: any) => (a.data.chapterNumber ?? 0) - (b.data.chapterNumber ?? 0));
    let bookSlugClean = strip(bookId);

    paths.push({
      params: { slug: bookSlugClean },
      props: { entry: entry, chapters: chapters, isChapter: false, bookSlugOverride: bookSlugClean },
    });

    for (const chapter of chapters) {
        const idx = chapters.findIndex((c: any) => c.id === chapter.id);
        let chapterSlugFull = strip(chapter.id);

        paths.push({
            params: { slug: chapterSlugFull },
            props: {
                entry: chapter,
                chapters: chapters,
                isChapter: true,
                prevChapter: idx > 0 ? chapters[idx - 1] : undefined,
                nextChapter: idx < chapters.length - 1 ? chapters[idx + 1] : undefined,
                bookSlugOverride: bookSlugClean
            },
        });
    }
  }

  return paths;
}


const { entry, chapters, isChapter, prevChapter, nextChapter, bookSlugOverride } = Astro.props;
const { Content, headings } = await render(entry);

const rawBookSlug = entry.data.bookSlug ?? bookSlugOverride ?? entry.id;
let bookSlugClean = stripPrefix(rawBookSlug);
bookSlugClean = bookSlugClean.replace(/\/index\.mdx?$/, '').replace(/\.mdx?$/, '');

const chapterList = chapters.map((c: any) => {
  let slug = stripPrefix(c.id).replace(/\.mdx?$/, '');
  if (slug.startsWith(bookSlugClean + '/')) {
      slug = slug.substring(bookSlugClean.length + 1);
  }
  return {
    slug: slug,
    title: c.data.title,
    chapterNumber: c.data.chapterNumber ?? 0,
  };
});

const articleUrl = new URL(Astro.url.pathname, Astro.site).toString();
---

{isChapter ? (
  <BookLayout
    title={entry.data.title}
    description={entry.data.description}
    lang={lang}
    bookSlug={bookSlugClean}
    chapterNumber={entry.data.chapterNumber}
    chapters={chapterList}
    headings={headings}
    prevChapter={prevChapter ? { 
      slug: stripPrefix(prevChapter.id).replace(`${bookSlugClean}/`, ''), 
      title: prevChapter.data.title, 
      chapterNumber: prevChapter.data.chapterNumber ?? 0 
    } : undefined}
    nextChapter={nextChapter ? { 
      slug: stripPrefix(nextChapter.id).replace(`${bookSlugClean}/`, ''), 
      title: nextChapter.data.title, 
      chapterNumber: nextChapter.data.chapterNumber ?? 0 
    } : undefined}
    draft={entry.data.draft}
    showHeader={entry.data['show-header']}
    tags={entry.data.tags || []}
    slug={`books/${stripPrefix(entry.id)}`}
  >
    <Content />
  </BookLayout>
) : (
  <BaseLayout title={entry.data.title} description={entry.data.description}>
    {entry.data.pdfUrl && <WidthToggle title={entry.data.title} author={entry.data.author} lang={lang} />}
    <div class="container-wide py-16">
      {entry.data.coverImage && (
        <img src={entry.data.coverImage} alt={entry.data.title} class="w-full max-w-sm mx-auto rounded-xl mb-8" loading="lazy" />
      )}
      <h1 class="text-3xl md:text-4xl font-bold mb-4">{entry.data.title}</h1>
      <p class="text-lg text-text-muted dark:text-text-dark-muted mb-8">{entry.data.description}</p>

      {/* PDF Only View */}
      {entry.data.pdfOnly && entry.data.pdfUrl ? (
        <div class="pdf-only-box mt-8">
           <PDFViewer pdfUrl={entry.data.pdfUrl} title={entry.data.title} lang={lang} />
           <div class="mt-8 flex justify-center">
             <a
               href={entry.data.pdfUrl}
               class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-primary text-white font-medium hover:opacity-90 transition-colors no-underline"
               download
             >
               <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
               {t('books.download_pdf', lang)}
             </a>
           </div>
        </div>
      ) : (
        <>
      {/* Tab interface if PDF viewer is enabled */}
      {entry.data.pdfUrl && entry.data.showPdfViewer && (
        <div class="book-tabs mb-8">
          <div class="flex justify-center mb-6">
            <div class="inline-flex p-1 bg-surface-dim dark:bg-surface-dark-dim rounded-lg border border-border dark:border-border-dark">
              <button
                class="book-tab-btn active px-6 py-2.5 rounded-md text-sm font-medium transition-colors"
                data-tab="chapters"
                type="button"
              >
                {t('books.chapters_tab', lang)}
              </button>
              <button
                class="book-tab-btn px-6 py-2.5 rounded-md text-sm font-medium transition-colors"
                data-tab="pdf"
                type="button"
              >
                {t('books.pdf_tab', lang)}
              </button>
            </div>
          </div>

          {/* Chapters Tab */}
          <div id="chapters-tab" class="book-tab-content active">
            {chapterList.length > 0 && (
              <div class="mb-8">
                <h2 class="text-xl font-bold mb-4">{t('books.toc', lang)}</h2>
                <ol class="space-y-2">
                  {chapterList.map((ch: any) => (
                    <li>
                      <a
                        href={`/books/${bookSlugClean}/${ch.slug}`}
                        class="flex items-center gap-3 p-3 rounded-lg border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline"
                      >
                        <span class="text-sm text-text-muted dark:text-text-dark-muted w-8 text-center shrink-0">
                          {ch.chapterNumber}
                        </span>
                        <span class="text-text-base dark:text-text-dark font-medium">{ch.title}</span>
                      </a>
                    </li>
                  ))}
                </ol>
              </div>
            )}

            <div class="prose mt-8">
              <Content />
            </div>
          </div>

          {/* PDF Tab */}
          <div id="pdf-tab" class="book-tab-content">
            <PDFViewer pdfUrl={entry.data.pdfUrl} title={entry.data.title} lang={lang} />
          </div>
        </div>
      )}

      {/* No PDF viewer - show traditional layout */}
      {(!entry.data.pdfUrl || !entry.data.showPdfViewer) && chapterList.length > 0 && (
        <div class="mb-8">
          <h2 class="text-xl font-bold mb-4">{t('books.toc', lang)}</h2>
          <ol class="space-y-2">
            {chapterList.map((ch: any) => (
              <li>
                <a
                  href={`/books/${bookSlugClean}/${ch.slug}`}
                  class="flex items-center gap-3 p-3 rounded-lg border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline"
                >
                  <span class="text-sm text-text-muted dark:text-text-dark-muted w-8 text-center shrink-0">
                    {ch.chapterNumber}
                  </span>
                  <span class="text-text-base dark:text-text-dark font-medium">{ch.title}</span>
                </a>
              </li>
            ))}
          </ol>
        </div>
      )}

      {(!entry.data.pdfUrl || !entry.data.showPdfViewer) && entry.data.pdfUrl && (
        <a
          href={entry.data.pdfUrl}
          class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-secondary text-white font-medium hover:bg-secondary-light transition-colors no-underline mb-8"
          download
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          {t('books.download_pdf', lang)}
        </a>
      )}

      {(!entry.data.pdfUrl || !entry.data.showPdfViewer) && (
        <div class="prose mt-8">
          <Content />
        </div>
      )}
      </>
      )}

      <div class="mt-16 pt-10 border-t border-border dark:border-border-dark">
        <!-- Rating -->
        <Rating contentId={`books/${bookSlugClean}`} lang={lang} />

        <!-- Tags -->
        {entry.data.tags && entry.data.tags.length > 0 && (
          <div class="mt-8 pt-6 border-t border-border dark:border-border-dark">
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-sm text-text-muted dark:text-text-dark-muted">{t('articles.tags', lang)}:</span>
              {entry.data.tags.map((tag: string) => (
                <a
                  href={getLocalizedPath(`tags/${encodeURIComponent(tag)}`, lang)}
                  class="text-xs px-2.5 py-1 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary hover:text-primary dark:hover:border-primary-light dark:hover:text-primary-light transition-colors no-underline"
                >
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Related Content -->
        {entry.data.tags && entry.data.tags.length > 0 && (
          <RelatedContent lang={lang} currentTags={entry.data.tags} currentSlug={`books/${bookSlugClean}`} />
        )}

        <!-- Share & Comments -->
        <div class="mt-8 pt-6 border-t border-border dark:border-border-dark">
          <ShareButtons title={entry.data.title} url={articleUrl} lang={lang} />
        </div>

        <Giscus lang={lang} />
      </div>
    </div>
  </BaseLayout>
)}

<style>
  .book-tab-btn {
    color: var(--color-text-muted);
  }

  html.dark .book-tab-btn {
    color: var(--color-text-dark-muted);
  }

  .book-tab-btn:hover {
    color: var(--color-text);
  }

  html.dark .book-tab-btn:hover {
    color: var(--color-text-dark);
  }

  .book-tab-btn.active {
    background-color: white;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    color: var(--color-primary);
  }

  html.dark .book-tab-btn.active {
    background-color: var(--color-surface-dark);
    color: var(--color-primary-light);
  }

  .book-tab-content {
    display: none;
  }

  .book-tab-content.active {
    display: block;
  }
</style>

<script>
  // Tab switching for book pages with PDF viewer
  document.addEventListener('DOMContentLoaded', () => {
    const tabButtons = document.querySelectorAll('.book-tab-btn');
    const tabContents = document.querySelectorAll('.book-tab-content');

    tabButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab');

        // Update active button
        tabButtons.forEach((btn) => btn.classList.remove('active'));
        button.classList.add('active');

        // Update active content
        tabContents.forEach((content) => {
          if (content.id === `${tab}-tab`) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });

        // Update URL hash
        window.history.replaceState(null, '', `#${tab}`);
      });
    });

    // Handle initial hash in URL
    const hash = window.location.hash.slice(1);
    if (hash === 'chapters' || hash === 'pdf') {
      const hashButton = document.querySelector(`[data-tab="${hash}"]`);
      if (hashButton) {
        (hashButton as HTMLElement).click();
      }
    }
  });
</script>
