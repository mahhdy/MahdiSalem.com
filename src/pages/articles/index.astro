---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { t, stripLangPrefix } from '../../i18n';
import { getCollection } from 'astro:content';

const lang = 'fa';

const allArticles = await getCollection('articles', ({ data }) => data.lang === 'fa' && !data.draft);
const articles = allArticles.sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

// Collect unique categories
const allCategories = [...new Set(articles.flatMap((a) => a.data.categories))];

const dateFormatter = new Intl.DateTimeFormat('fa-IR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout title={t('nav.articles', lang)}>
  <div class="container-wide py-16">
    <h1 class="text-3xl md:text-4xl font-bold mb-8">{t('nav.articles', lang)}</h1>

    {/* Category filter */}
    {allCategories.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8">
        <button class="category-filter text-sm px-3 py-1.5 rounded-full border border-primary text-primary dark:border-primary-light dark:text-primary-light font-medium" data-category="all">
          همه
        </button>
        {allCategories.map((cat) => (
          <button class="category-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors" data-category={cat}>
            {cat}
          </button>
        ))}
      </div>
    )}

    {articles.length > 0 ? (
      <div class="space-y-6">
        {articles.map((article) => (
          <a
            href={`/articles/${stripLangPrefix(article.id)}`}
            class="article-card group block p-6 rounded-xl border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline"
            data-categories={article.data.categories.join(',')}
          >
            <div class="flex flex-col sm:flex-row sm:items-start gap-4">
              {article.data.coverImage && (
                <img src={article.data.coverImage} alt={article.data.title} class="w-full sm:w-32 h-24 object-cover rounded-lg shrink-0" loading="lazy" />
              )}
              <div class="flex-1">
                <div class="flex flex-wrap items-center gap-2 mb-2">
                  {article.data.categories.map((cat) => (
                    <span class="text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary dark:bg-primary-light/10 dark:text-primary-light">{cat}</span>
                  ))}
                </div>
                <h2 class="text-lg font-bold mb-1 text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors">
                  {article.data.title}
                </h2>
                <p class="text-sm text-text-muted dark:text-text-dark-muted mb-2 line-clamp-2">{article.data.description}</p>
                <time datetime={article.data.publishDate.toISOString()} class="text-xs text-text-muted dark:text-text-dark-muted">
                  {dateFormatter.format(article.data.publishDate)}
                </time>
              </div>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <p class="text-text-muted dark:text-text-dark-muted">به زودی مقالات در این بخش منتشر خواهند شد.</p>
    )}
  </div>
</BaseLayout>

<script>
  const filters = document.querySelectorAll('.category-filter');
  const cards = document.querySelectorAll('.article-card');

  filters.forEach((btn) => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');

      // Update active state
      filters.forEach((f) => {
        f.classList.remove('border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium');
        f.classList.add('border-border', 'dark:border-border-dark', 'text-text-muted', 'dark:text-text-dark-muted');
      });
      btn.classList.remove('border-border', 'dark:border-border-dark', 'text-text-muted', 'dark:text-text-dark-muted');
      btn.classList.add('border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium');

      // Filter cards
      cards.forEach((card) => {
        const cats = card.getAttribute('data-categories') ?? '';
        if (category === 'all' || cats.split(',').includes(category!)) {
          (card as HTMLElement).style.display = '';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });
  });
</script>
