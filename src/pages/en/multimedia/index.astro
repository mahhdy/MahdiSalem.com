---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import CategoryTabView from '../../../components/CategoryTabView.astro';
import { t, stripLangPrefix } from '../../../i18n';
import { getCollection } from 'astro:content';
import { getCategoryName, getCategoriesByContentType } from '../../../data/categories';

const lang = 'en';

const allMultimedia = await getCollection('multimedia', ({ data }) => !data.draft && data.lang === 'en');

const multimedia = allMultimedia.sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

// derive available interfaces (preferred taxonomy) for multimedia
const allInterfaces = [...new Set(multimedia.map((m) => m.data.interface).filter(Boolean))];
const relevantCategories = getCategoriesByContentType('multimedia');
const availableInterfaces = allInterfaces.filter((iface) => relevantCategories.some((cat) => cat.slug === iface));

const dateFormatter = new Intl.DateTimeFormat('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Helper function to format duration
function formatDuration(seconds: number | undefined): string {
  if (!seconds) return '';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Helper function to get icon for media type
function getMediaIcon(type: string) {
  if (type === 'video') {
    return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>';
  } else if (type === 'audio') {
    return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg>';
  } else {
    return '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>';
  }
}
---

<BaseLayout title={t('multimedia.title', lang)}>
  <div class="container-wide py-16">
    <h1 class="text-3xl font-bold mb-8 text-center">{t('multimedia.title', lang)}</h1>

    <CategoryTabView contentType="multimedia" lang={lang} allItems={multimedia} defaultTab="categories">
    <div class="flex flex-col md:flex-row gap-6 mb-8">
      {/* Search */}
      <div class="flex-1 relative">
        <input
          type="text"
          id="search-input"
          placeholder={t('search.placeholder', lang)}
          class="w-full pl-10 pr-4 py-2 rounded-lg border border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim focus:ring-2 focus:ring-primary outline-none transition-all"
        />
        <svg class="absolute left-3 top-2.5 w-5 h-5 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      </div>

      {/* Sort */}
      <div class="flex items-center gap-2">
        <label for="sort-select" class="text-sm font-medium whitespace-nowrap">{t('sort.label', lang)}:</label>
        <select id="sort-select" class="px-3 py-2 rounded-lg border border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim outline-none focus:ring-2 focus:ring-primary">
          <option value="newest">{t('sort.newest', lang)}</option>
          <option value="oldest">{t('sort.oldest', lang)}</option>
        </select>
      </div>
    </div>

    {/* Type filter */}
    <div class="flex flex-wrap gap-2 mb-8">
      <button class="type-filter active text-sm px-3 py-1.5 rounded-full border border-primary text-primary dark:border-primary-light dark:text-primary-light font-medium" data-type="all">
        {t('multimedia.filter_all', lang)}
      </button>
      <button class="type-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors" data-type="video">
        {t('multimedia.filter_video', lang)}
      </button>
      <button class="type-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors" data-type="audio">
        {t('multimedia.filter_audio', lang)}
      </button>
      <button class="type-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors" data-type="podcast">
        {t('multimedia.filter_podcast', lang)}
      </button>
    </div>

    {/* Interface (taxonomy) filter â€” use `interface` field instead of raw category names */}
    {availableInterfaces.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8">
        <button class="category-filter active text-sm px-3 py-1.5 rounded-full border border-primary text-primary dark:border-primary-light dark:text-primary-light font-medium" data-category="all">
          All
        </button>
        {availableInterfaces.map((slug) => (
          <button class="category-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors" data-category={slug}>
            {getCategoryName(slug, lang)}
          </button>
        ))}
      </div>
    )}

    {multimedia.length > 0 ? (
      <div id="multimedia-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {multimedia.map((item) => (
          <a
            href={`/en/multimedia/${stripLangPrefix(item.id)}`}
            class="multimedia-card group block rounded-xl border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline overflow-hidden"
            data-type={item.data.type}
            data-interface={item.data.interface || 'unknown'}
            data-categories={item.data.categories.join(',')}
            data-title={item.data.title.toLowerCase()}
            data-desc={item.data.description.toLowerCase()}
            data-date={item.data.publishDate.getTime()}
          >
            {/* Thumbnail */}
            <div class="relative aspect-video bg-surface-dim dark:bg-surface-dark-dim">
              {item.data.thumbnailUrl ? (
                <img src={item.data.thumbnailUrl} alt={item.data.title} class="w-full h-full object-cover" loading="lazy" />
              ) : item.data.coverImage ? (
                <img src={item.data.coverImage} alt={item.data.title} class="w-full h-full object-cover" loading="lazy" />
              ) : (
                <div class="w-full h-full flex items-center justify-center text-text-muted dark:text-text-dark-muted">
                  <Fragment set:html={getMediaIcon(item.data.type)} />
                </div>
              )}
              {/* Duration Badge */}
              {item.data.duration && (
                <div class="absolute bottom-2 right-2 bg-black/80 text-white text-xs px-2 py-1 rounded">
                  {formatDuration(item.data.duration)}
                </div>
              )}
              {/* Type Badge */}
              <div class="absolute top-2 left-2 bg-primary/90 dark:bg-primary-light/90 text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                <Fragment set:html={getMediaIcon(item.data.type)} />
                <span>{t(`multimedia.${item.data.type}`, lang)}</span>
              </div>
            </div>

            {/* Content */}
            <div class="p-4">
              <div class="flex flex-wrap gap-2 mb-2">
                {item.data.interface && (
                  <span class="text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary dark:bg-primary-light/10 dark:text-primary-light">{getCategoryName(item.data.interface, lang)}</span>
                )}
                {item.data.categories.map((cat) => (
                  <span class="text-xs px-2 py-0.5 rounded-full bg-surface-dim text-text-muted dark:bg-surface-dark-dim dark:text-text-dark-muted">{cat}</span>
                ))}
              </div>
              <h2 class="text-lg font-bold mb-1 text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors line-clamp-2">
                {item.data.title}
              </h2>
              <p class="text-sm text-text-muted dark:text-text-dark-muted mb-2 line-clamp-2">{item.data.description}</p>
              <div class="flex items-center justify-between text-xs text-text-muted dark:text-text-dark-muted">
                <time datetime={item.data.publishDate.toISOString()}>
                  {dateFormatter.format(item.data.publishDate)}
                </time>
                {item.data.type === 'podcast' && item.data.episodeNumber && (
                  <span>{t('multimedia.episode', lang)} {item.data.episodeNumber}</span>
                )}
              </div>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <p class="text-text-muted dark:text-text-dark-muted">{t('multimedia.no_content', lang)}</p>
    )}
    </CategoryTabView>
  </div>
</BaseLayout>

<script>
  const typeFilters = document.querySelectorAll('.type-filter');
  const categoryFilters = document.querySelectorAll('.category-filter');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  const container = document.getElementById('multimedia-container');
  const cards = Array.from(document.querySelectorAll('.multimedia-card')) as HTMLElement[];

  let activeType = 'all';
  let activeCategory = 'all';
  let searchTerm = '';

  function update() {
    // 1. Filter
    cards.forEach((card) => {
      const type = card.getAttribute('data-type') ?? '';
      const iface = card.getAttribute('data-interface') ?? '';
      const cats = card.getAttribute('data-categories')?.split(',') ?? [];
      const title = card.getAttribute('data-title') ?? '';
      const desc = card.getAttribute('data-desc') ?? '';

      const typeMatch = activeType === 'all' || type === activeType;
      // Match by `interface` (preferred taxonomy). fallback: categories array.
      const categoryMatch = activeCategory === 'all' || iface === activeCategory || cats.includes(activeCategory);
      const searchMatch = title.includes(searchTerm) || desc.includes(searchTerm);

      card.style.display = (typeMatch && categoryMatch && searchMatch) ? '' : 'none';
    });

    // 2. Sort
    const sortBy = sortSelect.value;
    const visibleCards = cards.filter(c => c.style.display !== 'none');

    visibleCards.sort((a, b) => {
      if (sortBy === 'newest') return parseInt(b.getAttribute('data-date')!) - parseInt(a.getAttribute('data-date')!);
      if (sortBy === 'oldest') return parseInt(a.getAttribute('data-date')!) - parseInt(b.getAttribute('data-date')!);
      return 0;
    });

    visibleCards.forEach(card => container?.appendChild(card));
  }

  typeFilters.forEach((btn) => {
    btn.addEventListener('click', () => {
      activeType = btn.getAttribute('data-type') ?? 'all';
      typeFilters.forEach(f => f.classList.remove('active', 'border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium'));
      btn.classList.add('active', 'border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium');
      update();
    });
  });

  categoryFilters.forEach((btn) => {
    btn.addEventListener('click', () => {
      activeCategory = btn.getAttribute('data-category') ?? 'all';
      categoryFilters.forEach(f => f.classList.remove('active', 'border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium'));
      btn.classList.add('active', 'border-primary', 'text-primary', 'dark:border-primary-light', 'dark:text-primary-light', 'font-medium');
      update();
    });
  });

  searchInput?.addEventListener('input', (e) => {
    searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
    update();
  });

  sortSelect?.addEventListener('change', update);
</script>
