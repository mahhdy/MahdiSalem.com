---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import CategoryTabView from "../../../components/CategoryTabView.astro";
import { t, stripLangPrefix } from "../../../i18n";
import { getCollection } from "astro:content";
import {
    getCategoryName,
    getCategoriesByContentType,
} from "../../../data/categories";
import stats from "../../../data/stats.json";
import ratings from "../../../data/ratings.json";

const lang = "en";
const statsVisits = stats.visits as Record<string, number>;
const ratingsMap = ratings as Record<
    string,
    { average?: number; count?: number }
>;

const allDialoguesRaw = await getCollection(
    "dialogues",
    ({ data }) => data.lang === "en",
);

// Filter out hidden dialogues (unless ?force=true)
const allDialogues = allDialoguesRaw.filter(
    (a) => !a.data.hidden || Astro.url.searchParams.get("force") === "true",
);

// Pre-process dialogues with stats and ratings
const dialogues = allDialogues
    .map((a) => {
        const path = a.id.replace(/\.(md|mdx)$/, "").replace(/^content\//, "");
        return {
            ...a,
            visits: statsVisits[path] || 0,
            rating: ratingsMap[path]?.average || 0,
            votes: ratingsMap[path]?.count || 0,
        };
    })
    .sort(
        (a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime(),
    );

// Get all interface values from dialogues
const allInterfaces = [
    ...new Set(
        dialogues
            .map((a) => a.data.interface)
            .filter((value): value is string => Boolean(value)),
    ),
];
const relevantCategories = getCategoriesByContentType("dialogues");
const availableInterfaces = allInterfaces.filter((iface) =>
    relevantCategories.some((cat) => cat.slug === iface),
);

const dateFormatter = new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
});
---

<BaseLayout title={t("nav.dialogues", lang)}>
    <div class="container-wide py-16">
        <h1 class="text-3xl font-bold mb-8 text-center">
            {t("nav.dialogues", lang)}
        </h1>

        <CategoryTabView
            contentType="dialogues"
            lang={lang}
            allItems={dialogues}
        >
            <div class="flex flex-col md:flex-row gap-6 mb-8">
                {/* Search */}
                <div class="flex-1 relative">
                    <input
                        type="text"
                        id="search-input"
                        placeholder={t("search.placeholder", lang)}
                        class="w-full pl-10 pr-4 py-2 rounded-lg border border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim focus:ring-2 focus:ring-primary outline-none transition-all"
                    />
                    <svg
                        class="absolute left-3 top-2.5 w-5 h-5 text-text-muted"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path></svg
                    >
                </div>

                {/* Sort */}
                <div class="flex items-center gap-2">
                    <label
                        for="sort-select"
                        class="text-sm font-medium whitespace-nowrap"
                        >{t("sort.label", lang)}:</label
                    >
                    <select
                        id="sort-select"
                        class="px-3 py-2 rounded-lg border border-border dark:border-border-dark bg-surface-dim dark:bg-surface-dark-dim outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="newest">{t("sort.newest", lang)}</option>
                        <option value="oldest">{t("sort.oldest", lang)}</option>
                        <option value="popular"
                            >{t("sort.popular", lang)}</option
                        >
                        <option value="rating">{t("sort.rating", lang)}</option>
                    </select>
                </div>
            </div>

            {/* Category filter */}
            {
                availableInterfaces.length > 0 && (
                    <div class="flex flex-wrap gap-2 mb-8">
                        <button
                            class="category-filter active text-sm px-3 py-1.5 rounded-full border border-primary text-primary dark:border-primary-light dark:text-primary-light font-medium"
                            data-category="all"
                        >
                            All
                        </button>
                        {availableInterfaces.map((slug) => (
                            <button
                                class="category-filter text-sm px-3 py-1.5 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors"
                                data-category={slug}
                            >
                                {getCategoryName(slug, lang)}
                            </button>
                        ))}
                    </div>
                )
            }

            {
                dialogues.length > 0 ? (
                    <div
                        id="dialogues-container"
                        class="grid grid-cols-1 md:grid-cols-2 gap-6"
                    >
                        {dialogues.map((dialogue) => (
                            <a
                                href={`/en/dialogues/${stripLangPrefix(dialogue.id)}`}
                                class={`dialogue-card group block p-6 rounded-xl border ${dialogue.data.draft ? "border-dashed border-amber-300 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/10" : "border-border dark:border-border-dark"} hover:border-primary dark:hover:border-primary-light transition-colors no-underline`}
                                data-interface={
                                    dialogue.data.interface || "unknown"
                                }
                                data-title={dialogue.data.title.toLowerCase()}
                                data-desc={dialogue.data.description.toLowerCase()}
                                data-date={dialogue.data.publishDate.getTime()}
                                data-visits={dialogue.visits}
                                data-rating={dialogue.rating}
                            >
                                <div class="flex flex-col sm:flex-row sm:items-start gap-4">
                                    {dialogue.data.coverImage &&
                                        (dialogue.data.cardImage ?? "show") !==
                                            "hidden" && (
                                            <img
                                                src={dialogue.data.coverImage}
                                                alt={dialogue.data.title}
                                                class="w-full sm:w-32 h-24 object-cover rounded-lg shrink-0"
                                                loading="lazy"
                                            />
                                        )}
                                    <div class="flex-1">
                                        <div class="flex flex-wrap items-center justify-between gap-4 mb-2">
                                            <div class="flex flex-wrap gap-2">
                                                {dialogue.data.interface && (
                                                    <span class="text-xs px-2 py-0.5 rounded-full bg-primary/10 text-primary dark:bg-primary-light/10 dark:text-primary-light">
                                                        {getCategoryName(
                                                            dialogue.data
                                                                .interface,
                                                            lang,
                                                        )}
                                                    </span>
                                                )}
                                                <span class="text-[10px] px-1.5 py-0.5 rounded bg-surface dark:bg-surface-dark border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted uppercase tracking-tight">
                                                    {t(
                                                        "content.dialogue",
                                                        lang,
                                                    )}
                                                </span>
                                            </div>
                                            {dialogue.rating > 0 && (
                                                <div class="flex items-center gap-1 text-amber-500 text-xs font-bold">
                                                    <svg
                                                        class="w-3 h-3 fill-current"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                    </svg>
                                                    <span>
                                                        {dialogue.rating.toFixed(
                                                            1,
                                                        )}
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                        <h2 class="text-lg font-bold mb-1 text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors">
                                            {dialogue.data.title}
                                        </h2>
                                        <p class="text-[11px] text-text-muted dark:text-text-dark-muted mb-1 italic">
                                            {dialogue.data.participants.join(
                                                " & ",
                                            )}
                                        </p>
                                        <p class="text-sm text-text-muted dark:text-text-dark-muted mb-2 line-clamp-2">
                                            {dialogue.data.description}
                                        </p>
                                        <div class="flex items-center justify-between text-xs text-text-muted dark:text-text-dark-muted">
                                            <time
                                                datetime={dialogue.data.publishDate.toISOString()}
                                            >
                                                {dateFormatter.format(
                                                    dialogue.data.publishDate,
                                                )}
                                            </time>
                                            <span class="opacity-60">
                                                {dialogue.visits.toLocaleString(
                                                    "en-US",
                                                )}{" "}
                                                visits
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        ))}
                    </div>
                ) : (
                    <p class="text-text-muted dark:text-text-dark-muted">
                        Dialogues will be published here soon.
                    </p>
                )
            }
        </CategoryTabView>
    </div>
</BaseLayout>

<script>
    const filters = document.querySelectorAll(".category-filter");
    const searchInput = document.getElementById(
        "search-input",
    ) as HTMLInputElement;
    const sortSelect = document.getElementById(
        "sort-select",
    ) as HTMLSelectElement;
    const container = document.getElementById("dialogues-container");
    const cards = Array.from(
        document.querySelectorAll(".dialogue-card"),
    ) as HTMLElement[];

    const params = new URLSearchParams(window.location.search);
    const initialInterface = params.get("interface") || "all";

    let activeCategory = "all";
    let searchTerm = "";

    function syncUrl() {
        const url = new URL(window.location.href);
        if (activeCategory === "all") {
            url.searchParams.delete("interface");
        } else {
            url.searchParams.set("interface", activeCategory);
        }
        window.history.replaceState(null, "", `${url.pathname}${url.search}`);
    }

    function update() {
        cards.forEach((card) => {
            const iface = card.getAttribute("data-interface") ?? "";
            const title = card.getAttribute("data-title") ?? "";
            const desc = card.getAttribute("data-desc") ?? "";
            const categoryMatch =
                activeCategory === "all" || iface === activeCategory;
            const searchMatch =
                title.includes(searchTerm) || desc.includes(searchTerm);
            card.style.display = categoryMatch && searchMatch ? "" : "none";
        });

        const sortBy = sortSelect.value;
        const visibleCards = cards.filter((c) => c.style.display !== "none");
        visibleCards.sort((a, b) => {
            if (sortBy === "newest")
                return (
                    parseInt(b.getAttribute("data-date")!) -
                    parseInt(a.getAttribute("data-date")!)
                );
            if (sortBy === "oldest")
                return (
                    parseInt(a.getAttribute("data-date")!) -
                    parseInt(b.getAttribute("data-date")!)
                );
            if (sortBy === "popular")
                return (
                    parseInt(b.getAttribute("data-visits")!) -
                    parseInt(a.getAttribute("data-visits")!)
                );
            if (sortBy === "rating")
                return (
                    parseFloat(b.getAttribute("data-rating")!) -
                    parseFloat(a.getAttribute("data-rating")!)
                );
            return 0;
        });
        visibleCards.forEach((card) => container?.appendChild(card));
    }

    filters.forEach((btn) => {
        btn.addEventListener("click", () => {
            activeCategory = btn.getAttribute("data-category") ?? "all";
            filters.forEach((f) =>
                f.classList.remove(
                    "active",
                    "border-primary",
                    "text-primary",
                    "dark:border-primary-light",
                    "dark:text-primary-light",
                    "font-medium",
                ),
            );
            btn.classList.add(
                "active",
                "border-primary",
                "text-primary",
                "dark:border-primary-light",
                "dark:text-primary-light",
                "font-medium",
            );
            syncUrl();
            update();
        });
    });

    searchInput?.addEventListener("input", (e) => {
        searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
        update();
    });
    sortSelect?.addEventListener("change", update);

    const initialButton = document.querySelector(
        `.category-filter[data-category="${initialInterface}"]`,
    ) as HTMLButtonElement | null;
    if (initialButton) initialButton.click();
    else update();
</script>
