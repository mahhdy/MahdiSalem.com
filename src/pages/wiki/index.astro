---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { t, stripLangPrefix } from '../../i18n';
import { getCollection } from 'astro:content';

const lang = 'fa';

const allWiki = await getCollection('wiki', ({ data }) => data.lang === 'fa' && !data.draft);
const wikiPages = allWiki.sort((a, b) => a.data.order - b.data.order);

// Group by section
const sections = new Map<string, typeof wikiPages>();
for (const page of wikiPages) {
  const section = page.data.section ?? 'عمومی';
  if (!sections.has(section)) sections.set(section, []);
  sections.get(section)!.push(page);
}
---

<BaseLayout title={t('nav.wiki', lang)}>
  <div class="container-wide py-16">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
      <h1 class="text-3xl md:text-4xl font-bold">{t('nav.wiki', lang)}</h1>
      <a
        href="https://github.com/Mahhdy/mahdisalem.com/issues/new?template=wiki-suggestion.md"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-border dark:border-border-dark text-sm hover:border-primary dark:hover:border-primary-light hover:text-primary dark:hover:text-primary-light transition-colors no-underline"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
        {t('wiki.contribute', lang)}
      </a>
    </div>

    {wikiPages.length > 0 ? (
      <div class="space-y-10">
        {[...sections.entries()].map(([sectionName, pages]) => (
          <div>
            <h2 class="text-xl font-bold mb-4 text-primary dark:text-primary-light">{sectionName}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              {pages.map((page) => (
                <a
                  href={`/wiki/${stripLangPrefix(page.id)}`}
                  class="group block p-5 rounded-xl border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline"
                >
                  <h3 class="font-bold mb-1 text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors">
                    {page.data.title}
                  </h3>
                  <p class="text-sm text-text-muted dark:text-text-dark-muted line-clamp-2">
                    {page.data.description}
                  </p>
                </a>
              ))}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <p class="text-text-muted dark:text-text-dark-muted">به زودی محتوای ویکی در این بخش منتشر خواهد شد.</p>
    )}
  </div>
</BaseLayout>
