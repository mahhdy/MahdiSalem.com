---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import PDFViewer from '../../components/PDFViewer.astro';
import { t } from '../../i18n';
import { getCollection, render } from 'astro:content';

const lang = 'fa';

export async function getStaticPaths() {
  const statements = await getCollection('statements', ({ data }) => data.lang === 'fa' && !data.draft);
  return statements.map((s) => ({ params: { slug: s.id.replace(/^fa\//, '') }, props: { entry: s } }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const dateFormatter = new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
const articleUrl = new URL(Astro.url.pathname, Astro.site).toString();

const typeLabels: Record<string, string> = {
  statement: 'بیانیه',
  press: 'اطلاعیه مطبوعاتی',
  position: 'موضع‌گیری',
};
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <article class="container-narrow py-16">
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-3">
        <span class="text-xs px-2.5 py-1 rounded-full bg-accent/10 text-accent dark:bg-accent-light/10 dark:text-accent-light font-medium">
          {typeLabels[entry.data.type] ?? entry.data.type}
        </span>
        <time datetime={entry.data.publishDate.toISOString()} class="text-sm text-text-muted dark:text-text-dark-muted">
          {dateFormatter.format(entry.data.publishDate)}
        </time>
      </div>
      <h1 class="text-3xl md:text-4xl font-bold">{entry.data.title}</h1>
    </header>

    <div class="prose">
      {entry.data.pdfOnly && entry.data.pdfUrl ? (
        <div class="pdf-only-statement">
          <PDFViewer pdfUrl={entry.data.pdfUrl} title={entry.data.title} lang={lang} />
          <div class="mt-8 flex justify-center">
            <a
              href={entry.data.pdfUrl}
              class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-primary text-white font-medium hover:opacity-90 transition-colors no-underline"
              download
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              {t('books.download_pdf', lang)}
            </a>
          </div>
        </div>
      ) : (
        <Content />
      )}
    </div>

    <div class="mt-8 pt-6 border-t border-border dark:border-border-dark">
      <ShareButtons title={entry.data.title} url={articleUrl} lang={lang} />
    </div>
  </article>
</BaseLayout>
