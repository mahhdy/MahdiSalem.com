---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { t, getLocalizedPath, stripLangPrefix } from '../../i18n';
import { getCollection } from 'astro:content';

const lang = 'fa';

export async function getStaticPaths() {
  const allArticles = await getCollection('articles', ({ data }) => data.lang === 'fa' && !data.draft);
  const allBooks = await getCollection('books', ({ data }) => data.lang === 'fa' && !data.draft && !data.bookSlug);

  const tagSet = new Set<string>();
  allArticles.forEach((a) => a.data.tags.forEach((t) => tagSet.add(t)));
  allBooks.forEach((b) => b.data.tags.forEach((t) => tagSet.add(t)));

  return [...tagSet].map((tag) => ({
    params: { tag },
    props: {
      tag,
      articles: allArticles.filter((a) => a.data.tags.includes(tag))
        .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime()),
      books: allBooks.filter((b) => b.data.tags.includes(tag))
        .sort((a, b) => a.data.order - b.data.order),
    },
  }));
}

const { tag, articles, books } = Astro.props;

const dateFormatter = new Intl.DateTimeFormat('fa-IR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
---

<BaseLayout title={`${t('tags.all_tagged', lang)} «${tag}»`}>
  <div class="container-wide py-16">
    <div class="mb-8">
      <a
        href={getLocalizedPath('tags', lang)}
        class="text-sm text-primary dark:text-primary-light hover:underline"
      >
        &rarr; {t('tags.back_to_tags', lang)}
      </a>
    </div>

    <h1 class="text-3xl md:text-4xl font-bold mb-2">
      #{tag}
    </h1>
    <p class="text-text-muted dark:text-text-dark-muted mb-10">
      {t('tags.all_tagged', lang)} «{tag}»
    </p>

    {/* Articles section */}
    {articles.length > 0 && (
      <section class="mb-12">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="px-2.5 py-1 text-xs rounded-full bg-primary/10 text-primary dark:bg-primary-light/10 dark:text-primary-light">
            {articles.length}
          </span>
          {t('nav.articles', lang)}
        </h2>
        <div class="space-y-4">
          {articles.map((article) => (
            <a
              href={`/articles/${stripLangPrefix(article.id)}`}
              class="group block p-5 rounded-xl border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline"
            >
              <h3 class="text-lg font-bold text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors mb-1">
                {article.data.title}
              </h3>
              <p class="text-sm text-text-muted dark:text-text-dark-muted mb-2 line-clamp-2">{article.data.description}</p>
              <time datetime={article.data.publishDate.toISOString()} class="text-xs text-text-muted dark:text-text-dark-muted">
                {dateFormatter.format(article.data.publishDate)}
              </time>
            </a>
          ))}
        </div>
      </section>
    )}

    {/* Books section */}
    {books.length > 0 && (
      <section class="mb-12">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
          <span class="px-2.5 py-1 text-xs rounded-full bg-secondary/10 text-secondary dark:bg-secondary-light/10 dark:text-secondary-light">
            {books.length}
          </span>
          {t('nav.books', lang)}
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {books.map((book) => (
            <a
              href={`/books/${stripLangPrefix(book.id)}`}
              class="group block rounded-xl border border-border dark:border-border-dark hover:border-primary dark:hover:border-primary-light transition-colors no-underline overflow-hidden"
            >
              {book.data.coverImage && (
                <img src={book.data.coverImage} alt={book.data.title} class="w-full h-48 object-cover" loading="lazy" />
              )}
              <div class="p-5">
                <h3 class="text-lg font-bold text-text-base dark:text-text-dark group-hover:text-primary dark:group-hover:text-primary-light transition-colors mb-1">
                  {book.data.title}
                </h3>
                <p class="text-sm text-text-muted dark:text-text-dark-muted line-clamp-2">{book.data.description}</p>
              </div>
            </a>
          ))}
        </div>
      </section>
    )}

    {articles.length === 0 && books.length === 0 && (
      <p class="text-text-muted dark:text-text-dark-muted">{t('tags.no_content', lang)}</p>
    )}
  </div>
</BaseLayout>
