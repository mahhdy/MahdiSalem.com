---
import BaseLayout from './BaseLayout.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import ReadingTime from '../components/ReadingTime.astro';
import RelatedContent from '../components/RelatedContent.astro';
import ShareButtons from '../components/ShareButtons.astro';
import Giscus from '../components/Giscus.astro';
import Rating from '../components/Rating.astro';
import { t, getLocalizedPath, stripLangPrefix,  type Locale } from '../i18n';

interface Props {
  title: string;
  description: string;
  lang: Locale;
  publishDate: Date;
  updatedDate?: Date;
  author?: string;
  categories?: string[];
  tags?: string[];
  coverImage?: string;
  rawContent?: string;
  slug?: string;
  draft?: boolean;
}

const {
  title,
  description,
  lang,
  publishDate,
  updatedDate,
  author = 'مهدی سالم',
  categories = [],
  tags = [],
  coverImage,
  rawContent = '',
  slug = '',
  draft = false,
} = Astro.props;

const dateFormatter = new Intl.DateTimeFormat(lang === 'fa' ? 'fa-IR' : 'en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const articleUrl = new URL(Astro.url.pathname, Astro.site).toString();
---

<BaseLayout title={title} description={description}>
  <ReadingProgress />

  <article class="container-article py-10">
    <!-- Header -->
    <header class="mb-8">
      {categories.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-3">
          {categories.map((cat) => (
            <span class="text-xs px-2.5 py-1 rounded-full bg-primary/10 text-primary dark:bg-primary-light/10 dark:text-primary-light font-medium">
              {cat}
            </span>
          ))}
        </div>
      )}

      <h1 class="text-3xl md:text-4xl font-bold mb-4">{title}</h1>

      <div class="flex flex-wrap items-center gap-4 text-sm text-text-muted dark:text-text-dark-muted">
        <span>{author}</span>
        <span>&middot;</span>
        <time datetime={publishDate.toISOString()}>
          {dateFormatter.format(publishDate)}
        </time>
        {updatedDate && (
          <>
            <span>&middot;</span>
            <time datetime={updatedDate.toISOString()}>
              Updated: {dateFormatter.format(updatedDate)}
            </time>
          </>
        )}
        {rawContent && (
          <>
            <span>&middot;</span>
            <ReadingTime lang={lang} content={rawContent} />
          </>
        )}
      </div>
    </header>

    {coverImage && (
      <img
        src={coverImage}
        alt={title}
        class="w-full rounded-xl mb-8 object-cover max-h-96"
        loading="lazy"
      />
    )}

    <!-- Content -->
    <div class="prose">
      {draft && (
        <div class="bg-amber-50 dark:bg-amber-900/20 text-amber-800 dark:text-amber-200 px-4 py-3 rounded-lg mb-8 border border-amber-200 dark:border-amber-800/50 flex items-start gap-3">
          <svg class="w-5 h-5 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
          <div>
            <p class="text-sm font-bold mb-1">{t('draft.label', lang)}</p>
            <p class="text-sm opacity-90 m-0">
              {t('draft.warning', lang)}
            </p>
          </div>
        </div>
      )}
      <slot />
    </div>

    <!-- Rating -->
    <Rating contentId={slug ? `articles/${slug}` : `articles/${stripLangPrefix(Astro.url.pathname)}`} lang={lang} />

    <!-- Tags -->
    {tags.length > 0 && (
      <div class="mt-8 pt-6 border-t border-border dark:border-border-dark">
        <div class="flex flex-wrap items-center gap-2">
          <span class="text-sm text-text-muted dark:text-text-dark-muted">{t('articles.tags', lang)}:</span>
          {tags.map((tag) => (
            <a
              href={getLocalizedPath(`tags/${encodeURIComponent(tag)}`, lang)}
              class="text-xs px-2.5 py-1 rounded-full border border-border dark:border-border-dark text-text-muted dark:text-text-dark-muted hover:border-primary hover:text-primary dark:hover:border-primary-light dark:hover:text-primary-light transition-colors no-underline"
            >
              #{tag}
            </a>
          ))}
        </div>
      </div>
    )}
    <!-- Related Content -->
    {tags.length > 0 && slug && (
      <RelatedContent lang={lang} currentTags={tags} currentSlug={slug} />
    )}
 
    <!-- Share & Comments -->
    <div class="mt-8 pt-6 border-t border-border dark:border-border-dark">
      <ShareButtons title={title} url={articleUrl} lang={lang} />
    </div>

    <Giscus lang={lang} />
  </article>
</BaseLayout>
